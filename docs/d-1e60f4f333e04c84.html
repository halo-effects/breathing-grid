<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIT Dashboard ‚Äî Adaptive Intelligence Trading</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--green:#3fb950;--red:#f85149;--amber:#d29922;--blue:#58a6ff;--purple:#bc8cff;--text:#e6edf3;--text2:#8b949e;--text3:#484f58}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;padding:16px}
a{color:var(--blue)}
.header{display:flex;align-items:center;justify-content:space-between;padding:8px 0 16px;border-bottom:1px solid var(--border);margin-bottom:16px}
.header h1{font-size:1.4rem;font-weight:600;display:flex;align-items:center;gap:12px}
.logo-wrap{width:48px;height:48px;display:flex;align-items:center;justify-content:center}
.header-right{display:flex;align-items:center;gap:12px;font-size:.8rem;color:var(--text2)}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.status-dot.running{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.halted{background:var(--red);box-shadow:0 0 6px var(--red)}
.status-dot.stopped{background:var(--amber);box-shadow:0 0 6px var(--amber)}

/* Account switcher */
.account-switcher{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.account-pill{padding:6px 14px;border-radius:20px;font-size:.75rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--text2);transition:all .2s;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
.account-pill:hover{border-color:var(--blue);color:var(--text)}
.account-pill.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.account-pill .pill-dot{width:6px;height:6px;border-radius:50%;display:inline-block}
.paper-badge{display:inline-block;background:rgba(210,153,34,.2);color:var(--amber);font-size:.7rem;font-weight:700;padding:3px 10px;border-radius:4px;letter-spacing:1px;animation:breathe 3s infinite;margin-left:8px}
.account-type-badge{font-size:.7rem;color:var(--text2);margin-left:8px}
@keyframes breathe{0%,100%{opacity:.7}50%{opacity:1}}

.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(100%,160px),1fr));gap:12px;margin-bottom:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden}
.card-label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.card-value{font-size:1.5rem;font-weight:700}
.card-sub{font-size:.75rem;color:var(--text2);margin-top:4px}
.badge{display:inline-block;font-size:.65rem;font-weight:600;padding:2px 7px;border-radius:4px;text-transform:uppercase;letter-spacing:.3px}
.badge-green{background:rgba(63,185,80,.15);color:var(--green)}
.badge-red{background:rgba(248,81,73,.15);color:var(--red)}
.badge-amber{background:rgba(210,153,34,.15);color:var(--amber)}
.badge-blue{background:rgba(88,166,255,.15);color:var(--blue)}
.badge-purple{background:rgba(188,140,255,.15);color:var(--purple)}
.badge-gray{background:rgba(139,148,158,.15);color:var(--text2)}
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.chart-box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
.chart-box h3{font-size:.8rem;color:var(--text2);margin-bottom:12px;font-weight:500}
.chart-wrap{position:relative;height:260px}
.section{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px}
.section h2{font-size:1rem;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.trades-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.trades-grid.single{grid-template-columns:1fr}
.trade-panel{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px}
.trade-panel-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:.95rem;font-weight:600}
.deal-progress{position:relative;height:36px;background:#21262d;border-radius:6px;margin:16px 0;overflow:visible}
.deal-progress-fill{height:100%;border-radius:6px;position:absolute;top:0;left:0}
.deal-marker{position:absolute;top:0;height:100%;width:2px;z-index:2}
.deal-marker-label{position:absolute;top:-18px;font-size:.6rem;color:var(--text2);white-space:nowrap;transform:translateX(-50%)}
.deal-marker-dot{position:absolute;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;margin-left:-4px}
.deal-current{z-index:3}
.deal-current .deal-marker-dot{width:14px;height:14px;margin-left:-6px;background:var(--blue);box-shadow:0 0 8px var(--blue);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 4px var(--blue)}50%{box-shadow:0 0 12px var(--blue)}}
.deal-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
.deal-stat{padding:8px 0}
.deal-stat-label{font-size:.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:.3px}
.deal-stat-value{font-size:.95rem;font-weight:600;margin-top:2px}
.no-deal{text-align:center;padding:32px;color:var(--text2);font-size:.9rem}
.trade-chart-wrap{height:180px;margin-bottom:16px}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{text-align:left;color:var(--text2);font-weight:500;padding:8px 6px;border-bottom:1px solid var(--border);font-size:.7rem;text-transform:uppercase;letter-spacing:.3px}
td{padding:7px 6px;border-bottom:1px solid #1c2128}
tr:hover td{background:rgba(88,166,255,.04)}
.pnl-pos{color:var(--green)}
.pnl-neg{color:var(--red)}
.bottom-bar{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 20px;font-size:.78rem;color:var(--text2)}
.bottom-stat{display:flex;flex-direction:column;align-items:center;gap:2px}
.bottom-stat span:first-child{font-size:.6rem;text-transform:uppercase;letter-spacing:.3px}
.bottom-stat span:last-child{color:var(--text);font-weight:600;font-size:.85rem}
.dd-gauge{width:80px;height:6px;background:#21262d;border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle}
.dd-gauge-fill{height:100%;border-radius:3px;transition:width .5s}
.footer{text-align:center;padding:12px;font-size:.7rem;color:var(--text3)}
.alloc-badge{font-size:.7rem;color:var(--text2);display:flex;align-items:center;gap:6px}
.alloc-badge .alloc-long{color:var(--green)}
.alloc-badge .alloc-short{color:var(--red)}
.regime-strip{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.regime-item{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--text2)}
.regime-dot{width:8px;height:8px;border-radius:50%}
.adaptive-viz{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
.adaptive-meter{position:relative;height:8px;background:#21262d;border-radius:4px;overflow:hidden;margin-top:6px}
.adaptive-meter-fill{height:100%;border-radius:4px;transition:width .8s ease}
.adaptive-label{display:flex;justify-content:space-between;font-size:.65rem;color:var(--text3);margin-top:3px}
.features-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.feature-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;text-align:center;transition:transform .25s ease,border-color .25s ease,box-shadow .25s ease;cursor:default}
.feature-card:hover{transform:scale(1.5);border-color:var(--blue);box-shadow:0 4px 24px rgba(88,166,255,.15);z-index:1}
.feature-icon{font-size:1.5rem;margin-bottom:8px}
.feature-title{font-size:.8rem;font-weight:600;margin-bottom:4px}
.feature-desc{font-size:.7rem;color:var(--text2);line-height:1.4}

/* Conviction gauge */
.conviction-gauge{position:relative;width:200px;height:120px;margin:0 auto 16px}
.conviction-gauge svg{width:100%;height:100%}
.conviction-score-text{font-size:2.5rem;font-weight:800;text-anchor:middle}
.conviction-band-text{font-size:.8rem;text-anchor:middle;text-transform:uppercase;letter-spacing:1px}
.conviction-breakdown{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.conviction-item{text-align:center;padding:10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)}
.conviction-item-label{font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:4px}
.conviction-item-value{font-size:1.2rem;font-weight:700}
.conviction-multipliers{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.conviction-mult{text-align:center;padding:8px;background:var(--bg);border-radius:6px;border:1px solid var(--border)}
.conviction-mult-label{font-size:.6rem;color:var(--text3);margin-bottom:2px}
.conviction-mult-value{font-size:.95rem;font-weight:600}

/* Macro indicators */
.macro-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.macro-card{text-align:center;padding:16px;background:var(--bg);border-radius:8px;border:1px solid var(--border)}
.macro-card-label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.macro-card-value{font-size:2rem;font-weight:800}
.macro-card-sub{font-size:.7rem;color:var(--text2);margin-top:4px}
.fg-bar{height:8px;border-radius:4px;margin-top:8px;background:linear-gradient(90deg,#f85149 0%,#d29922 25%,#e6edf3 50%,#3fb950 75%,#3fb950 100%)}
.fg-indicator{width:12px;height:12px;border-radius:50%;border:2px solid #fff;position:relative;margin-top:-10px;transition:margin-left .5s}

/* Spot coin card */
.spot-coin-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:12px}
.spot-coin-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.spot-coin-symbol{font-size:1.2rem;font-weight:700}
.spot-coin-state{font-size:.8rem}
.layer-progress{position:relative;height:32px;background:#21262d;border-radius:6px;margin:12px 0;overflow:visible}
.layer-fill{height:100%;border-radius:6px;position:absolute;top:0;left:0;background:linear-gradient(90deg,rgba(88,166,255,.2),rgba(88,166,255,.4))}
.sentiment-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:12px}
.sentiment-narrative{font-size:.78rem;color:var(--text2);line-height:1.5;font-style:italic}

/* Coin selector for portfolio mode */
.coin-selector{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:16px}
.coin-mini-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:default;transition:border-color .2s}
.coin-mini-card:hover{border-color:var(--blue)}
.coin-mini-card.winding-down{opacity:.55;border-style:dashed}
.coin-mini-card .coin-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.coin-mini-card .coin-symbol{font-weight:700;font-size:1rem}
.coin-mini-card .coin-score{font-size:.7rem;color:var(--text2)}
.coin-mini-card .coin-details{display:flex;flex-wrap:wrap;gap:6px;font-size:.7rem;color:var(--text2)}
.coin-section{margin-bottom:16px}
.coin-section-header{display:flex;align-items:center;gap:10px;padding:10px 0;cursor:pointer;user-select:none}
.coin-section-header h3{font-size:.95rem;font-weight:600;margin:0}
.coin-section-header .collapse-icon{transition:transform .2s;font-size:.7rem;color:var(--text2)}
.coin-section-header .collapse-icon.collapsed{transform:rotate(-90deg)}
.coin-section-body{overflow:hidden;transition:max-height .3s ease}
.coin-section-body.collapsed{max-height:0!important;padding:0}
.rotation-table{margin-top:8px}
.rotation-table td,.rotation-table th{font-size:.72rem;padding:5px 8px}
.rotation-badge-add{color:var(--green)}
.rotation-badge-remove{color:var(--red)}
.rotation-badge-winddown{color:var(--amber)}

/* Lifecycle pipeline */
.lifecycle-pipeline{display:flex;align-items:center;gap:0;margin:8px 0}
.lifecycle-stage{padding:6px 14px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;background:var(--bg);border:1px solid var(--border);color:var(--text3);position:relative;transition:all .3s}
.lifecycle-stage:first-child{border-radius:6px 0 0 6px}
.lifecycle-stage:last-child{border-radius:0 6px 6px 0}
.lifecycle-stage.active{color:#fff;border-color:transparent;animation:stagePulse 2s infinite}
.lifecycle-stage.discover.active{background:var(--purple)}
.lifecycle-stage.accumulate.active{background:var(--blue)}
.lifecycle-stage.compound.active{background:var(--green)}
.lifecycle-stage.exit.active{background:var(--amber)}
.lifecycle-stage.rotate.active{background:var(--red)}
.lifecycle-arrow{color:var(--text3);font-size:.6rem;margin:0 -1px;z-index:1}
@keyframes stagePulse{0%,100%{opacity:1}50%{opacity:.7}}

/* DCA Layer Viz */
.dca-viz{position:relative;height:200px;margin:12px 0;display:flex;gap:16px}
.dca-price-axis{width:4px;background:linear-gradient(180deg,var(--green),var(--border),var(--red));border-radius:2px;position:relative;flex-shrink:0}
.dca-layer{position:absolute;left:12px;right:0;height:2px;display:flex;align-items:center}
.dca-layer-line{flex:1;height:2px;border-radius:1px}
.dca-layer-label{font-size:.6rem;white-space:nowrap;margin-left:8px;min-width:120px}
.dca-layer-dot{width:8px;height:8px;border-radius:50%;position:absolute;left:-2px;transform:translateY(-50%)}

/* Compounding tracker */
.compound-bar{height:12px;background:#21262d;border-radius:6px;overflow:hidden;margin:8px 0}
.compound-bar-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--blue),var(--green));transition:width .8s}

/* Manual controls */
.ctrl-section{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
.ctrl-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.ctrl-btn{padding:4px 12px;border-radius:16px;font-size:.7rem;font-weight:600;cursor:pointer;border:1px solid;transition:all .2s;display:inline-flex;align-items:center;gap:4px}
.ctrl-btn-safe{background:rgba(63,185,80,.1);color:var(--green);border-color:rgba(63,185,80,.3)}
.ctrl-btn-safe:hover{background:rgba(63,185,80,.25)}
.ctrl-btn-warn{background:rgba(210,153,34,.1);color:var(--amber);border-color:rgba(210,153,34,.3)}
.ctrl-btn-warn:hover{background:rgba(210,153,34,.25)}
.ctrl-btn-danger{background:rgba(248,81,73,.1);color:var(--red);border-color:rgba(248,81,73,.3)}
.ctrl-btn-danger:hover{background:rgba(248,81,73,.25)}
.ctrl-btn-danger.confirming{background:var(--red);color:#fff;animation:dangerPulse 1s infinite}
@keyframes dangerPulse{0%,100%{opacity:1}50%{opacity:.8}}
.ctrl-input{background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:4px;padding:3px 8px;font-size:.7rem;width:60px;text-align:center}
.ctrl-label{font-size:.7rem;color:var(--text2)}
.ctrl-divider{width:1px;height:20px;background:var(--border);margin:0 4px}

@media(max-width:900px){.charts-row{grid-template-columns:1fr}.trades-grid{grid-template-columns:1fr}.adaptive-viz{grid-template-columns:1fr}.macro-grid{grid-template-columns:1fr}.conviction-breakdown{grid-template-columns:1fr}.risk-profile-grid{grid-template-columns:1fr!important}}
@media(max-width:600px){
body{padding:8px}
.header{flex-direction:column;align-items:flex-start;gap:8px;padding:8px 0 12px}
.header h1{font-size:1.1rem;gap:8px}
.logo-wrap{width:36px;height:36px}
.logo-wrap svg{width:36px;height:36px}
.header-right{width:100%;justify-content:flex-start;flex-wrap:wrap;gap:8px}
.cards{grid-template-columns:repeat(2,1fr);gap:8px}
.card{padding:10px}
.card-value{font-size:1.15rem}
.card-sub{font-size:.68rem}
.section{padding:12px}
.charts-row{grid-template-columns:1fr;gap:8px}
.chart-wrap{height:200px}
.trade-chart-wrap{height:140px}
.trades-grid{grid-template-columns:1fr}
.trade-panel{padding:12px}
.deal-stats{grid-template-columns:repeat(2,1fr);gap:8px}
.deal-stat-value{font-size:.85rem}
.features-grid{grid-template-columns:1fr 1fr;gap:8px}
.feature-card{padding:12px}
.feature-card:hover{transform:none;box-shadow:none;border-color:var(--border)}
.bottom-bar{flex-direction:row;flex-wrap:wrap;justify-content:center;gap:10px;padding:10px 12px}
.bottom-stat span:last-child{font-size:.78rem}
th,td{padding:5px 3px;font-size:.68rem}
.section h2{font-size:.9rem}
.adaptive-viz{grid-template-columns:1fr}
.coin-selector{grid-template-columns:1fr}
.regime-strip{gap:6px}
.regime-item{font-size:.68rem}
.alloc-badge{font-size:.65rem}
table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
.macro-grid{grid-template-columns:1fr}
.conviction-breakdown{grid-template-columns:1fr}
.conviction-multipliers{grid-template-columns:repeat(2,1fr)}
.account-switcher{gap:4px}
.account-pill{padding:4px 10px;font-size:.68rem}
}
@media(max-width:380px){
.cards{grid-template-columns:1fr}
.features-grid{grid-template-columns:1fr}
.card-value{font-size:1rem}
}
</style>
</head>
<body>
<div class="header">
  <h1>
    <a href="./" style="display:flex;align-items:center;text-decoration:none;color:inherit;">
    <div class="logo-wrap">
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
        <rect x="4" y="4" width="40" height="40" rx="4" stroke="#30363d" stroke-width="1" fill="rgba(22,27,34,.8)"/>
        <line x1="4" y1="17.3" x2="44" y2="17.3" stroke="#30363d" stroke-width="0.7"/>
        <line x1="4" y1="24" x2="44" y2="24" stroke="#30363d" stroke-width="0.7"/>
        <line x1="4" y1="30.7" x2="44" y2="30.7" stroke="#30363d" stroke-width="0.7"/>
        <line x1="17.3" y1="4" x2="17.3" y2="44" stroke="#30363d" stroke-width="0.7"/>
        <line x1="24" y1="4" x2="24" y2="44" stroke="#30363d" stroke-width="0.7"/>
        <line x1="30.7" y1="4" x2="30.7" y2="44" stroke="#30363d" stroke-width="0.7"/>
        <circle cx="24" cy="24" r="6" stroke="#58a6ff" stroke-width="2" fill="none" opacity=".9">
          <animate attributeName="r" values="6;9;6" dur="3s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values=".9;.3;.9" dur="3s" repeatCount="indefinite"/>
        </circle>
        <circle cx="24" cy="24" r="11" stroke="#3fb950" stroke-width="1.5" fill="none" opacity=".5">
          <animate attributeName="r" values="11;14;11" dur="3s" repeatCount="indefinite" begin="0.5s"/>
          <animate attributeName="opacity" values=".5;.15;.5" dur="3s" repeatCount="indefinite" begin="0.5s"/>
        </circle>
        <circle cx="24" cy="24" r="16" stroke="#d29922" stroke-width="1" fill="none" opacity=".3">
          <animate attributeName="r" values="16;18;16" dur="3s" repeatCount="indefinite" begin="1s"/>
          <animate attributeName="opacity" values=".3;.1;.3" dur="3s" repeatCount="indefinite" begin="1s"/>
        </circle>
        <circle cx="24" cy="24" r="3" fill="#58a6ff">
          <animate attributeName="r" values="3;4;3" dur="3s" repeatCount="indefinite"/>
        </circle>
        <path d="M24 8l4 5h-8z" fill="#3fb950" opacity=".8">
          <animate attributeName="opacity" values=".8;.3;.8" dur="3s" repeatCount="indefinite"/>
        </path>
        <path d="M24 40l4-5h-8z" fill="#f85149" opacity=".8">
          <animate attributeName="opacity" values=".8;.3;.8" dur="3s" repeatCount="indefinite" begin="1.5s"/>
        </path>
      </svg>
    </div>
    Adaptive Intelligence Trading
    </a>
    <span id="paperBadge" class="paper-badge" style="display:none">PAPER</span>
    <span id="accountTypeBadge" class="account-type-badge"></span>
  </h1>
  <div class="header-right">
    <span id="allocBadge" class="alloc-badge"></span>
    <span id="symbolBadge" class="badge badge-blue">---</span>
    <span><span id="statusDot" class="status-dot stopped"></span> <span id="statusLabel">Loading</span></span>
    <span id="lastUpdated" style="font-size:.7rem;color:var(--text3)"></span>
  </div>
</div>

<!-- Exchange Tabs -->
<div class="account-switcher" id="accountSwitcher">
  <span class="account-pill" data-id="live" onclick="switchAccount('live')"><span class="pill-dot" style="background:var(--green)"></span>Aster Futures</span>
</div>

<div class="cards" id="cards">
  <div class="card"><div class="card-label">Equity</div><div class="card-value" id="cEquity">--</div><div class="card-sub" id="cEquitySub"></div></div>
  <div class="card"><div class="card-label">Realized PnL</div><div class="card-value" id="cRealPnl">--</div><div class="card-sub" id="cRealPnlSub"></div></div>
  <div class="card"><div class="card-label">Unrealized PnL</div><div class="card-value" id="cUnrealPnl">--</div><div class="card-sub" id="cUnrealPnlSub"></div></div>
  <div class="card" id="cardFunding"><div class="card-label">Funding Fees</div><div class="card-value" id="cFunding">--</div><div class="card-sub" id="cFundingSub"></div></div>
  <div class="card"><div class="card-label">Win / Loss</div><div class="card-value" id="cWinLoss">--</div><div class="card-sub" id="cWinLossSub"></div></div>
  <div class="card"><div class="card-label">Win Rate</div><div class="card-value" id="cWinRate">--</div><div class="card-sub" id="cWinRateSub"></div></div>
  <div class="card"><div class="card-label">Avg Daily ROI</div><div class="card-value" id="cAvgROI">--</div><div class="card-sub" id="cAvgROISub"></div></div>
</div>

<!-- Portfolio: Coin Selector Panel (hidden in single-coin mode) -->
<div class="section" id="coinSelectorSection" style="display:none">
  <h2>ü™ô Active Coins <span id="coinSelectorCount" style="font-size:.8rem;color:var(--text2);font-weight:400"></span></h2>
  <div class="coin-selector" id="coinSelectorGrid"></div>
  <div style="display:flex;gap:16px;font-size:.72rem;color:var(--text2);margin-top:8px">
    <span>Last scan: <span id="scannerLastRun">--</span></span>
    <span>Next scan: <span id="scannerNextRun">--</span></span>
  </div>
</div>

<!-- Spot: Lifecycle Stage Indicator -->
<div class="section" id="lifecycleSection" style="display:none">
  <h2>üîÑ Lifecycle Pipeline</h2>
  <div id="lifecycleContent"></div>
</div>

<!-- Spot: Compounding Tracker -->
<div class="section" id="compoundingSection" style="display:none">
  <h2>üìà Compounding Tracker</h2>
  <div id="compoundingContent"></div>
</div>

<!-- Spot: Risk Profile & Regime -->
<div class="section" id="riskProfileSection" style="display:none">
  <h2>üõ°Ô∏è Risk Profile & Regime</h2>
  <div id="riskProfileContent"></div>
</div>

<!-- Spot: Conviction Panel -->
<div class="section" id="convictionSection" style="display:none">
  <h2>üéØ Conviction Scoring</h2>
  <div id="convictionContent"></div>
</div>

<!-- Spot: Macro Indicators -->
<div class="section" id="macroSection" style="display:none">
  <h2>üåç Macro Indicators</h2>
  <div class="macro-grid" id="macroContent"></div>
</div>

<!-- Futures: Adaptive Intelligence Panel -->
<div class="section" id="adaptiveSection">
  <h2>üß† Adaptive Intelligence</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
    <div>
      <div style="font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Market Regime</div>
      <div id="regimeDisplay" style="font-size:1.2rem;font-weight:700;margin-bottom:6px">--</div>
      <div id="regimeDesc" style="font-size:.75rem;color:var(--text2);line-height:1.4">--</div>
    </div>
    <div>
      <div style="font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Take Profit</div>
      <div style="display:flex;align-items:baseline;gap:6px">
        <span id="tpValue" style="font-size:1.8rem;font-weight:700">--</span>
        <span style="font-size:.8rem;color:var(--text2)">%</span>
      </div>
      <div class="adaptive-meter"><div class="adaptive-meter-fill" id="tpMeter" style="width:0%;background:var(--green)"></div></div>
      <div class="adaptive-label"><span id="tpMin">1.0%</span><span id="tpMax">2.5%</span></div>
    </div>
    <div>
      <div style="font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Grid Deviation</div>
      <div style="display:flex;align-items:baseline;gap:6px">
        <span id="devValue" style="font-size:1.8rem;font-weight:700">--</span>
        <span style="font-size:.8rem;color:var(--text2)">%</span>
      </div>
      <div class="adaptive-meter"><div class="adaptive-meter-fill" id="devMeter" style="width:0%;background:var(--amber)"></div></div>
      <div class="adaptive-label"><span id="devMin">1.2%</span><span id="devMax">4.0%</span></div>
    </div>
  </div>
  <div style="margin-top:16px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
    <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
      <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:4px">ATR (14)</div>
      <div id="atrValue" style="font-size:1.1rem;font-weight:600">--</div>
      <div id="atrLabel" style="font-size:.65rem;color:var(--text2);margin-top:2px">--</div>
    </div>
    <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
      <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:4px">TP Multiplier</div>
      <div id="tpMultValue" style="font-size:1.1rem;font-weight:600">--</div>
      <div style="font-size:.65rem;color:var(--text2);margin-top:2px">Regime-based</div>
    </div>
    <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
      <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:4px">Dev Multiplier</div>
      <div id="devMultValue" style="font-size:1.1rem;font-weight:600">--</div>
      <div style="font-size:.65rem;color:var(--text2);margin-top:2px">Regime-based</div>
    </div>
    <div style="text-align:center;padding:10px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
      <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:4px">Funding Fees</div>
      <div style="font-size:1.1rem;font-weight:600" id="cFundingTotal">--</div>
      <div style="font-size:.65rem;color:var(--text2);margin-top:2px" id="cFundingRate">--</div>
    </div>
  </div>
</div>

<!-- Spot: Coin Selector -->
<div class="section" id="spotCoinSelectorSection" style="display:none">
  <h2>ü™ô Active Coins <span id="spotCoinCount" style="font-size:.8rem;color:var(--text2);font-weight:400"></span></h2>
  <div class="coin-selector" id="spotCoinSelectorGrid"></div>
</div>

<!-- Spot: Coin Accumulation -->
<div class="section" id="spotCoinsSection" style="display:none">
  <h2>ü™ô Coin Positions</h2>
  <div id="spotCoinsContent"></div>
</div>

<!-- Spot: DCA Layer Visualization -->
<div class="section" id="dcaLayerSection" style="display:none">
  <h2>üìä DCA Layer Visualization</h2>
  <div id="dcaLayerContent"></div>
</div>

<!-- Spot: Manual Controls Panel -->
<div class="section" id="manualControlsSection" style="display:none">
  <h2>üéõÔ∏è Manual Controls</h2>
  <div id="manualControlsContent"></div>
</div>

<!-- Spot: Smart Entry Leaderboard -->
<div class="section" id="spotScannerSection" style="display:none">
  <h2>üèÜ Smart Entry Leaderboard <span id="spotScannerStatus" style="font-size:.8rem;color:var(--text2);font-weight:400"></span></h2>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
    <div style="display:flex;align-items:center;gap:6px">
      <span class="badge badge-blue" id="spotScanTotal">--</span>
      <span style="font-size:.7rem;color:var(--text3)">scanned ‚Üí</span>
      <span class="badge badge-purple" id="spotScanMature">--</span>
      <span style="font-size:.7rem;color:var(--text3)">mature ‚Üí</span>
      <span class="badge badge-green" id="spotScanQualified">--</span>
      <span style="font-size:.7rem;color:var(--text3)">backtested</span>
    </div>
    <div style="margin-left:auto;font-size:.72rem;color:var(--text2)">
      <span>Last scan: <span id="spotScanLastRun">--</span></span>
    </div>
  </div>
  <div id="spotScanRecommendation" style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:16px">
    <span id="spotScanAction" class="badge" style="font-size:.8rem;padding:4px 12px">--</span>
    <span id="spotScanActionText" style="font-size:.85rem;color:var(--text2)">Loading scanner data...</span>
  </div>
  <div style="overflow-x:auto">
    <table>
      <thead><tr>
        <th style="width:36px">#</th><th>Coin</th><th>Score</th><th>Daily ROI</th>
        <th>Win Rate</th><th>Max DD</th><th>Status</th><th>Action</th>
      </tr></thead>
      <tbody id="spotScannerTableBody"><tr><td colspan="8" style="text-align:center;color:var(--text3)">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Spot: Toast notification -->
<div id="cmdToast" style="display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--green);color:#000;padding:10px 20px;border-radius:8px;font-size:.8rem;font-weight:600;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.4);transition:opacity .3s">Copied!</div>

<!-- Spot: Sentiment -->
<div class="section" id="sentimentSection" style="display:none">
  <h2>üí¨ Sentiment Analysis</h2>
  <div id="sentimentContent"></div>
</div>

<!-- Coin Scanner Section -->
<div class="section" id="scannerSection">
  <h2>üîç Coin Scanner <span id="scannerStatus" style="font-size:.8rem;color:var(--text2);font-weight:400"></span></h2>
  <div id="scannerContent">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:6px">
        <span class="badge badge-blue" id="scanFunnelTotal">--</span>
        <span style="font-size:.7rem;color:var(--text3)">scanned ‚Üí</span>
        <span class="badge badge-purple" id="scanFunnelMature">--</span>
        <span style="font-size:.7rem;color:var(--text3)">mature ‚Üí</span>
        <span class="badge badge-green" id="scanFunnelTech">--</span>
        <span style="font-size:.7rem;color:var(--text3)">backtested</span>
      </div>
      <div style="margin-left:auto;display:flex;gap:12px;font-size:.72rem;color:var(--text2)">
        <span>Last scan: <span id="scanLastRun">--</span></span>
      </div>
    </div>
    <div id="scanRecommendation" style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:16px">
      <span id="scanAction" class="badge" style="font-size:.8rem;padding:4px 12px">--</span>
      <span id="scanActionText" style="font-size:.85rem;color:var(--text2)">Loading scanner data...</span>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:.75rem;color:var(--text2);margin-bottom:8px"><span style="font-weight:600;color:var(--text)">Filtered Out</span> ‚Äî coins rejected by maturity checks</div>
      <div id="scanFilterBreakdown" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px"></div>
    </div>
    <div style="overflow-x:auto">
      <table id="scannerTable">
        <thead><tr>
          <th style="width:36px">#</th><th>Coin</th><th>Score</th><th>Daily ROI</th>
          <th title="Average completed deal cycles per day">Cycles/Day</th>
          <th>Win Rate</th><th>Max DD</th><th>Profit (14d)</th><th>Avg SOs</th><th>Friendly Regimes</th>
        </tr></thead>
        <tbody id="scannerTableBody"><tr><td colspan="10" style="text-align:center;color:var(--text3)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<div class="section" id="dealSection">
  <h2 id="dealTitle">Active Trades</h2>
  <div id="dealContent"><div class="no-deal">Loading...</div></div>
</div>

<div class="charts-row" id="chartsRow">
  <div class="chart-box"><h3>Account Value</h3><div class="chart-wrap"><canvas id="chartPriceEq"></canvas></div></div>
  <div class="chart-box">
    <h3 style="font-size:1rem;margin-bottom:16px">Capital Utilization</h3>
    <div style="display:flex;align-items:center;justify-content:center;gap:48px;height:calc(100% - 46px)">
      <canvas id="capDonutLg" width="220" height="220" style="flex-shrink:0"></canvas>
      <div style="display:flex;flex-direction:column;gap:24px;min-width:200px">
        <div><div style="font-size:.8rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Utilization</div><div id="cCapUtilLg" style="font-size:3rem;font-weight:700;line-height:1">--</div></div>
        <div style="display:flex;flex-direction:column;gap:14px" id="cCapSubLg">
          <div style="display:flex;align-items:center;gap:10px"><span style="width:14px;height:14px;border-radius:50%;background:#58a6ff;display:inline-block"></span><span style="font-size:1rem;color:var(--text2)">Active</span><span id="capActive" style="font-size:1.15rem;font-weight:600;margin-left:auto">--</span></div>
          <div style="display:flex;align-items:center;gap:10px"><span style="width:14px;height:14px;border-radius:50%;background:#d29922;display:inline-block"></span><span style="font-size:1rem;color:var(--text2)">Pending</span><span id="capPending" style="font-size:1.15rem;font-weight:600;margin-left:auto">--</span></div>
          <div style="display:flex;align-items:center;gap:10px"><span style="width:14px;height:14px;border-radius:50%;background:#21262d;display:inline-block;border:1px solid var(--border)"></span><span style="font-size:1rem;color:var(--text2)">Reserve</span><span id="capAvailable" style="font-size:1.15rem;font-weight:600;margin-left:auto">--</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="section" id="tradeHistorySection">
  <h2>Trade History <span id="tradeCount" style="font-size:.8rem;color:var(--text2);font-weight:400"></span></h2>
  <div class="trade-chart-wrap"><canvas id="chartTrades"></canvas></div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <div style="display:flex;align-items:center;gap:8px">
      <span style="font-size:.75rem;color:var(--text2)">Show:</span>
      <select id="tradePageSize" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:3px 8px;font-size:.75rem;cursor:pointer">
        <option value="10" selected>10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option>
      </select>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button id="tradePrev" style="background:var(--bg);color:var(--text2);border:1px solid var(--border);border-radius:4px;padding:4px 10px;font-size:.75rem;cursor:pointer" disabled>‚Üê Prev</button>
      <span id="tradePageInfo" style="font-size:.75rem;color:var(--text2)">Page 1</span>
      <button id="tradeNext" style="background:var(--bg);color:var(--text2);border:1px solid var(--border);border-radius:4px;padding:4px 10px;font-size:.75rem;cursor:pointer">Next ‚Üí</button>
    </div>
  </div>
  <div style="overflow-x:auto"><table><thead><tr><th>Time</th><th>Symbol</th><th>Action</th><th>Dir</th><th>Price</th><th>TP Target</th><th>Qty</th><th>Duration</th><th>Orders</th><th>PnL</th><th>Regime</th></tr></thead><tbody id="tradesBody"></tbody></table></div>
</div>

<!-- Portfolio: Rotation History -->
<div class="section" id="rotationSection" style="display:none">
  <h2>üîÑ Rotation History</h2>
  <div style="overflow-x:auto"><table class="rotation-table"><thead><tr><th>Time</th><th>Action</th><th>Symbol</th><th>Reason</th></tr></thead><tbody id="rotationBody"><tr><td colspan="4" style="text-align:center;color:var(--text2);padding:16px">No rotation events yet</td></tr></tbody></table></div>
</div>

<div class="section" id="openOrdersSection">
  <h2>Open Orders <span id="openOrderCount" style="font-size:.8rem;color:var(--text2);font-weight:400"></span></h2>
  <div style="overflow-x:auto"><table><thead><tr><th>Side</th><th>Symbol</th><th>Trade</th><th>Type</th><th>Price</th><th>Proj. TP</th><th>Qty</th><th>Size (USD)</th><th>Distance</th></tr></thead><tbody id="openOrdersBody"><tr><td colspan="9" style="text-align:center;color:var(--text2);padding:20px">Loading...</td></tr></tbody></table></div>
</div>

<div class="bottom-bar" id="bottomBar">
  <div class="bottom-stat"><span>Trading</span><span id="bTrading">--</span></div>
  <div class="bottom-stat"><span>Avg Profit</span><span id="bAvgProfit">--</span></div>
  <div class="bottom-stat"><span>Avg Duration</span><span id="bAvgDur">--</span></div>
  <div class="bottom-stat"><span>Avg Orders</span><span id="bAvgSO">--</span></div>
  <div class="bottom-stat"><span>Uptime</span><span id="bUptime">--</span></div>
  <div class="bottom-stat"><span>Drawdown</span><span id="bDD">--</span> <div class="dd-gauge"><div class="dd-gauge-fill" id="bDDBar" style="width:0%;background:var(--green)"></div></div></div>
  <div class="bottom-stat" id="bLeverageStat"><span>Leverage</span><span id="bLeverage">1√ó</span></div>
  <div class="bottom-stat"><span>Margin Reserve</span><span id="bReserve">10%</span></div>
</div>

<!-- System Features (futures only) -->
<div class="section" id="featuresSection">
  <h2>‚ö° System Features</h2>
  <div class="features-grid">
    <div class="feature-card"><div class="feature-icon">üîÑ</div><div class="feature-title">Dual-Tracking</div><div class="feature-desc">Simultaneous LONG + SHORT deals capture profit in both directions. Never miss a move.</div></div>
    <div class="feature-card"><div class="feature-icon">üß†</div><div class="feature-title">Regime Detection</div><div class="feature-desc">5 market regimes auto-detected. Allocation, parameters, and risk adjust in real-time.</div></div>
    <div class="feature-card"><div class="feature-icon">ü´Å</div><div class="feature-title">Breathing Grid</div><div class="feature-desc">TP and deviation expand in volatile markets, contract in tight ranges. ATR-driven adaptation.</div></div>
    <div class="feature-card"><div class="feature-icon">üß≠</div><div class="feature-title">Directional Awareness</div><div class="feature-desc">SMA50 trend detection flips long/short allocation in bearish conditions.</div></div>
    <div class="feature-card"><div class="feature-icon">üõ°Ô∏è</div><div class="feature-title">Margin-Aware</div><div class="feature-desc">10% capital reserve. Skips unaffordable orders. Cancels deep SOs to ensure TP placement.</div></div>
    <div class="feature-card"><div class="feature-icon">üí∞</div><div class="feature-title">Zero Maker Fees</div><div class="feature-desc">All TP and SO orders are limit orders ‚Äî 0% maker fee on Aster DEX.</div></div>
    <div class="feature-card"><div class="feature-icon">üìà</div><div class="feature-title">Auto-Compound</div><div class="feature-desc">Capital syncs to equity each cycle. Profits and deposits automatically scale up order sizing.</div></div>
    <div class="feature-card"><div class="feature-icon">ü™ô</div><div class="feature-title">Multi-Coin Portfolio</div><div class="feature-desc">Trade 2-3 coins simultaneously. Two-tier scanner finds optimal candidates.</div></div>
  </div>
</div>

<div class="footer">Next refresh in <span id="countdown">15</span>s ¬∑ AIT Dashboard v4.0</div>

<script>
const $ = id => document.getElementById(id);

// ‚îÄ‚îÄ Account Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACCOUNTS = {
  'paper-aster': { label: 'Aster Spot', type: 'spot', exchange: 'Aster' },
  'paper-hyper': { label: 'Hyperliquid Spot', type: 'spot', exchange: 'Hyperliquid' },
  'live':        { label: 'Aster Futures', type: 'futures', exchange: 'Aster' },
};
const DATA_PREFIX = location.hostname.includes('github.io') ? 'data/' : '';
let ACCOUNT_ID = 'live';
let ACCOUNT = ACCOUNTS[ACCOUNT_ID];
let IS_SPOT = ACCOUNT.type === 'spot';
let ACCT_DATA = DATA_PREFIX + ACCOUNT_ID + '/';

function updateAccountUI() {
  document.querySelectorAll('.account-pill').forEach(p => {
    p.classList.toggle('active', p.dataset.id === ACCOUNT_ID);
  });
  $('accountTypeBadge').textContent = ACCOUNT.label;
  $('paperBadge').style.display = 'none';
  document.title = `AIT Dashboard ‚Äî ${ACCOUNT.label}`;
}
updateAccountUI();

async function switchAccount(id) {
  if (!ACCOUNTS[id] || id === ACCOUNT_ID) return;
  ACCOUNT_ID = id;
  ACCOUNT = ACCOUNTS[id];
  IS_SPOT = ACCOUNT.type === 'spot';
  ACCT_DATA = DATA_PREFIX + id + '/';
  // Reset state
  status = null; history = []; trades = [];
  if (chartPE) { chartPE.destroy(); chartPE = null; }
  if (chartTrades) { chartTrades.destroy(); chartTrades = null; }
  updateAccountUI();
  await init();
}

let status = null, history = [], trades = [], chartPE = null, chartPnl = null, chartTrades = null;
let countdownVal = 15, historyCountdown = 300;
let isPortfolioMode = false, portfolioStatus = null;

function fmt(n, d=2) { return n == null ? '--' : Number(n).toFixed(d); }
function fmtUsd(n, d=2) { return n == null ? '--' : '$' + fmt(n, d); }
function pctColor(v) { return v > 0 ? 'var(--green)' : v < 0 ? 'var(--red)' : 'var(--text)'; }
function regimeBadge(r, showDirection) {
  const m = {ACCUMULATION:'badge-blue',ACC:'badge-blue',MILD_TREND:'badge-green',TREND:'badge-green',TRENDING:'badge-green',VOLATILE:'badge-amber',CRASH:'badge-red',RANGING:'badge-purple',EXTREME:'badge-red',CHOPPY:'badge-amber'};
  let dirHtml = '';
  if (showDirection && status && status.trend_direction) {
    const directionalRegimes = ['TRENDING', 'MILD_TREND', 'DISTRIBUTION'];
    if (directionalRegimes.includes(r)) {
      const isBull = status.trend_direction === 'bullish';
      const arrow = isBull ? '‚ñ≤' : '‚ñº';
      const color = isBull ? 'var(--green)' : 'var(--red)';
      dirHtml = ` <span style="color:${color};font-weight:700">${arrow}</span>`;
    }
  }
  return `<span class="badge ${m[r]||'badge-gray'}">${r||'--'}${dirHtml}</span>`;
}
function dirBadge(d) { return `<span class="badge ${d==='LONG'||d==='long'?'badge-green':'badge-red'}">${(d||'--').toUpperCase()}</span>`; }
function durStr(ms) {
  if(!ms||ms<0) return '--';
  let s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60), d=Math.floor(h/24);
  if(d>0) return d+'d '+((h%24))+'h';
  if(h>0) return h+'h '+(m%60)+'m';
  if(m>0) return m+'m';
  return s+'s';
}

const REGIME_DESCRIPTIONS = {
  ACCUMULATION: 'Low volatility accumulation zone ‚Äî tight parameters, frequent small captures',
  RANGING: 'Price oscillating in a range ‚Äî ideal for grid trading',
  MILD_TREND: 'Gentle directional movement ‚Äî slight allocation bias toward trend',
  TRENDING: 'Strong directional move ‚Äî wider parameters, heavier trend-side allocation',
  VOLATILE: 'High volatility detected ‚Äî wider grid spacing, cautious sizing',
  EXTREME: 'Extreme conditions ‚Äî trading halted for capital protection',
  CHOPPY: 'Choppy/noisy price action ‚Äî balanced allocation, tighter parameters',
};

function parseCSV(text) {
  const lines = text.trim().split('\n');
  if(lines.length<2) return [];
  const hdr = lines[0].split(',');
  return lines.slice(1).map(l => {
    const vals = l.split(',');
    const obj = {};
    hdr.forEach((h,i) => obj[h.trim()] = vals[i]?.trim() || '');
    return obj;
  });
}

function getActiveDeals(s) {
  const deals = [];
  if (s.long_deal && !s.long_deal.closed) deals.push(s.long_deal);
  if (s.short_deal && !s.short_deal.closed) deals.push(s.short_deal);
  if (deals.length === 0 && s.deal && !s.deal.closed) deals.push(s.deal);
  return deals;
}

function calcUnreal(deal, price) {
  if (!deal || deal.closed || !deal.total_qty) return 0;
  return deal.direction === 'LONG'
    ? price * deal.total_qty - deal.total_cost
    : deal.total_cost - price * deal.total_qty;
}

// ‚îÄ‚îÄ Fetch Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchStatus() {
  // For futures live, try portfolio mode first
  if (!IS_SPOT && ACCOUNT_ID === 'live') {
    try {
      const r = await fetch(ACCT_DATA+'portfolio_status.json?t='+Date.now());
      if(r.ok) {
        const data = await r.json();
        if(data.mode === 'portfolio') {
          isPortfolioMode = true;
          portfolioStatus = data;
          showFuturesUI();
          renderPortfolio();
          return;
        }
      }
    } catch(e) {}
  }

  try {
    isPortfolioMode = false;
    portfolioStatus = null;
    const r = await fetch(ACCT_DATA+'status.json?t='+Date.now());
    if(!r.ok) return;
    status = await r.json();

    if (IS_SPOT) {
      showSpotUI();
      renderSpotStatus();
    } else {
      showFuturesUI();
      renderStatus();
    }
    if (!IS_SPOT) {
      $('coinSelectorSection').style.display = 'none';
      $('rotationSection').style.display = 'none';
    }
  } catch(e) { console.warn('status fetch failed', e); }
}

async function fetchHistory() {
  try {
    const r = await fetch(ACCT_DATA+'history.json?t='+Date.now());
    if(!r.ok) return;
    history = await r.json();
    if(!Array.isArray(history)) history = [];
    renderCharts();
  } catch(e) {}
}

async function fetchTrades() {
  try {
    const r = await fetch(ACCT_DATA+'trades.csv?t='+Date.now());
    if(!r.ok) return;
    trades = parseCSV(await r.text());
    renderTrades();
  } catch(e) {}
}

// ‚îÄ‚îÄ UI Visibility Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSpotUI() {
  // Show spot sections
  $('lifecycleSection').style.display = '';
  $('compoundingSection').style.display = '';
  $('riskProfileSection').style.display = '';
  $('convictionSection').style.display = '';
  $('macroSection').style.display = '';
  $('spotCoinSelectorSection').style.display = '';
  $('spotCoinsSection').style.display = '';
  $('dcaLayerSection').style.display = '';
  $('manualControlsSection').style.display = '';
  $('spotScannerSection').style.display = '';
  $('sentimentSection').style.display = '';
  // Hide futures sections
  $('adaptiveSection').style.display = 'none';
  $('scannerSection').style.display = 'none';
  $('openOrdersSection').style.display = 'none';
  $('featuresSection').style.display = 'none';
  $('chartsRow').style.display = 'none';
  $('cardFunding').style.display = 'none';
  $('bLeverageStat').style.display = 'none';
}

function showFuturesUI() {
  $('lifecycleSection').style.display = 'none';
  $('compoundingSection').style.display = 'none';
  $('riskProfileSection').style.display = 'none';
  $('convictionSection').style.display = 'none';
  $('macroSection').style.display = 'none';
  $('spotCoinSelectorSection').style.display = 'none';
  $('spotCoinsSection').style.display = 'none';
  $('dcaLayerSection').style.display = 'none';
  $('manualControlsSection').style.display = 'none';
  $('spotScannerSection').style.display = 'none';
  $('sentimentSection').style.display = 'none';
  $('adaptiveSection').style.display = '';
  $('scannerSection').style.display = '';
  $('openOrdersSection').style.display = '';
  $('featuresSection').style.display = '';
  $('chartsRow').style.display = '';
  $('cardFunding').style.display = '';
  $('bLeverageStat').style.display = '';
}

// ‚îÄ‚îÄ Spot Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSpotStatus() {
  if (!status) return;
  const s = status;

  // Header
  const symbols = s.symbols || Object.keys(s.coins || {});
  $('symbolBadge').textContent = symbols.join(', ') + ' ¬∑ ' + (s.timeframe || '15m');
  const dot = $('statusDot');
  const acctPaused = s.account_paused || false;
  dot.className = 'status-dot ' + (s.halted ? 'halted' : acctPaused ? 'halted' : s.running ? 'running' : 'stopped');
  $('statusLabel').textContent = s.halted ? 'HALTED' : acctPaused ? 'PAUSED' : s.running ? 'Running' : 'Stopped';

  // Last updated
  if (s.last_update) {
    const d = new Date(s.last_update);
    const ago = Math.round((Date.now() - d.getTime()) / 60000);
    $('lastUpdated').textContent = 'Updated ' + (ago < 60 ? ago+'m ago' : Math.round(ago/60)+'h ago');
  }

  // Top cards
  $('cEquity').textContent = fmtUsd(s.equity);
  const pnlPct = s.pnl_pct || 0;
  $('cEquitySub').innerHTML = `Capital: ${fmtUsd(s.capital)} ¬∑ <span style="color:${pctColor(pnlPct)}">${pnlPct>=0?'+':''}${fmt(pnlPct)}%</span>`;

  $('cRealPnl').innerHTML = `<span style="color:${pctColor(s.total_realized_pnl)}">${fmtUsd(s.total_realized_pnl)}</span>`;
  $('cRealPnlSub').textContent = s.deals_completed + ' completed deal' + (s.deals_completed!==1?'s':'');

  // Unrealized from coins
  let totalUnreal = 0;
  Object.values(s.coins || {}).forEach(c => { totalUnreal += c.unrealized_pnl || 0; });
  $('cUnrealPnl').innerHTML = `<span style="color:${pctColor(totalUnreal)}">${fmtUsd(totalUnreal)}</span>`;
  const totalInvested = Object.values(s.coins || {}).reduce((a,c) => a + (c.invested||0), 0);
  const unrealPct = totalInvested > 0 ? (totalUnreal / totalInvested * 100) : 0;
  $('cUnrealPnlSub').innerHTML = `<span style="color:${pctColor(unrealPct)}">${unrealPct>=0?'+':''}${fmt(unrealPct)}%</span> on ${fmtUsd(totalInvested)} invested`;

  // Win/Loss
  $('cWinLoss').innerHTML = `<span style="color:var(--green)">${s.deals_completed}W</span> / <span style="color:var(--red)">0L</span>`;
  $('cWinLossSub').textContent = s.deals_completed + ' total';

  // Win Rate
  const wr = s.win_rate || 0;
  const wrc = wr > 80 ? 'var(--green)' : wr > 50 ? 'var(--amber)' : wr > 0 ? 'var(--red)' : 'var(--text2)';
  $('cWinRate').innerHTML = s.deals_completed > 0 ? `<span style="color:${wrc}">${fmt(wr,1)}%</span>` : '<span style="color:var(--text2)">&mdash;</span>';
  $('cWinRateSub').textContent = s.deals_completed > 0 ? s.deals_completed + ' trades' : 'No closed trades';

  // Avg daily ROI
  const startEq = s.capital || 10000;
  const totalROI = startEq > 0 ? ((s.total_realized_pnl || 0) / startEq * 100) : 0;
  $('cAvgROI').innerHTML = `<span style="color:${pctColor(totalROI)}">${totalROI>=0?'+':''}${fmt(totalROI, 3)}%</span>`;
  $('cAvgROISub').textContent = `on ${fmtUsd(startEq)} capital`;

  // Regime badge in alloc area
  $('allocBadge').innerHTML = `Regime: ${regimeBadge(s.regime, true)} ¬∑ Trend: <span style="color:${s.trend_direction==='bullish'?'var(--green)':'var(--red)'}">${s.trend_direction||'--'}</span>`;

  // Lifecycle
  renderLifecycle(s);
  // Compounding
  renderCompounding(s);
  // Risk Profile & Regime
  renderRiskProfile(s);
  // Coin Selector
  renderSpotCoinSelector(s);
  // Conviction Panel
  renderConviction(s);
  // Macro Panel
  renderMacro(s);
  // Coin Positions
  renderSpotCoins(s);
  // DCA Layers
  renderDCALayers(s);
  // Manual Controls
  renderManualControls(s);
  // Sentiment
  renderSentiment(s);
  // Capital utilization in bottom bar
  renderSpotBottom(s);
  // Deal section ‚Äî show spot coins as deal panels
  renderSpotDeals(s);
}

// ‚îÄ‚îÄ Lifecycle Pipeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLifecycle(s) {
  if (!s || !s.coins) return;
  const coins = s.coins;
  const symbols = s.symbols || Object.keys(coins);
  if (!symbols.length) { $('lifecycleSection').style.display = 'none'; return; }

  let html = '';
  symbols.forEach(sym => {
    const c = coins[sym];
    // Determine stage
    let stage = 'discover';
    if (c) {
      const layers = c.layers || 0;
      const exitPressure = s.sentiment?.[sym]?.exit_pressure || 0;
      if (exitPressure > 35) stage = 'exit';
      else if (s.deals_completed > 0 && layers > 0) stage = 'compound';
      else if (layers > 0) stage = 'accumulate';
      else stage = 'discover';
    }
    // Check rotation recommendation
    // (simple heuristic: if scanner suggests rotate for this coin)

    const stages = ['discover','accumulate','compound','exit','rotate'];
    const labels = ['Discover','Accumulate','Compound','Exit','Rotate'];
    html += `<div style="margin-bottom:10px"><div style="font-size:.8rem;font-weight:600;margin-bottom:6px">${sym}</div><div class="lifecycle-pipeline">`;
    stages.forEach((st, i) => {
      if (i > 0) html += '<span class="lifecycle-arrow">‚ñ∏</span>';
      html += `<div class="lifecycle-stage ${st}${st === stage ? ' active' : ''}">${labels[i]}</div>`;
    });
    html += '</div></div>';
  });
  $('lifecycleContent').innerHTML = html;
}

// ‚îÄ‚îÄ Compounding Tracker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCompounding(s) {
  if (!s) return;
  const startCap = s.capital || 10000;
  const equity = s.equity || startCap;
  const growth = ((equity - startCap) / startCap * 100);
  const totalPnl = s.total_realized_pnl || 0;
  const uptime = s.uptime_hours || 1;
  const dailyRate = totalPnl / uptime * 24;
  const monthly = dailyRate * 30;
  const annual = startCap * (Math.pow(1 + (dailyRate / startCap), 365) - 1);
  const wr = s.win_rate || 0;
  const deals = s.deals_completed || 0;
  const growthPct = Math.max(0, Math.min(100, (equity / (startCap * 2)) * 100));

  $('compoundingContent').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px">
      <div style="text-align:center;padding:14px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
        <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:6px">Starting Capital</div>
        <div style="font-size:1.6rem;font-weight:800">${fmtUsd(startCap)}</div>
      </div>
      <div style="text-align:center;padding:14px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
        <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:6px">Current Equity</div>
        <div style="font-size:1.6rem;font-weight:800;color:${pctColor(growth)}">${fmtUsd(equity)}</div>
      </div>
      <div style="text-align:center;padding:14px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
        <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:6px">Growth</div>
        <div style="font-size:1.6rem;font-weight:800;color:${pctColor(growth)}">${growth >= 0 ? '+' : ''}${fmt(growth)}%</div>
      </div>
      <div style="text-align:center;padding:14px;background:var(--bg);border-radius:8px;border:1px solid var(--border)">
        <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;margin-bottom:6px">Deals / Win Rate</div>
        <div style="font-size:1.6rem;font-weight:800">${deals} <span style="font-size:.9rem;color:var(--text2)">/ ${fmt(wr,0)}%</span></div>
      </div>
    </div>
    <div class="compound-bar"><div class="compound-bar-fill" style="width:${growthPct}%"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:.7rem;color:var(--text2);margin-top:4px">
      <span>${fmtUsd(startCap)}</span><span>Target: ${fmtUsd(startCap * 2)}</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px">
      <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
        <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Daily Rate</div>
        <div style="font-size:1rem;font-weight:600;color:${pctColor(dailyRate)}">${fmtUsd(dailyRate)}</div>
      </div>
      <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
        <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Monthly Proj.</div>
        <div style="font-size:1rem;font-weight:600;color:${pctColor(monthly)}">${fmtUsd(monthly)}</div>
      </div>
      <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
        <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Annual Proj. (compound)</div>
        <div style="font-size:1rem;font-weight:600;color:${pctColor(annual)}">${fmtUsd(annual)}</div>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ DCA Layer Visualization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDCALayers(s) {
  if (!s || !s.coins) return;
  const coins = Object.entries(s.coins).filter(([,c]) => c.layers > 0);
  if (!coins.length) { $('dcaLayerSection').style.display = 'none'; return; }
  $('dcaLayerSection').style.display = '';

  let html = '';
  coins.forEach(([sym, c]) => {
    const tp = c.next_tp_price || 0;
    const cur = c.current_price || 0;
    const avg = c.avg_entry || 0;
    const nextSO = c.next_so_price || 0;
    const layers = c.layers || 1;

    // Estimate SO prices from base entry and deviation pattern
    const basePrice = avg; // approximate
    const devPct = basePrice > 0 && nextSO > 0 ? ((basePrice - nextSO) / basePrice * 100 / layers) : 2.5;

    // Collect all price points
    const points = [];
    // Filled layers
    for (let i = 0; i < layers; i++) {
      const p = basePrice * (1 - devPct * i / 100);
      points.push({price: p, type: 'filled', label: i === 0 ? 'Base' : `SO${i}`, color: 'var(--amber)'});
    }
    // Unfilled future SOs (show up to 3 more)
    for (let i = layers; i < layers + 3; i++) {
      const p = basePrice * (1 - devPct * i / 100);
      points.push({price: p, type: 'unfilled', label: `SO${i}`, color: 'var(--text3)'});
    }
    points.push({price: cur, type: 'current', label: `Current $${cur.toFixed(2)}`, color: 'var(--blue)'});
    points.push({price: tp, type: 'tp', label: `TP $${tp.toFixed(2)}`, color: 'var(--green)'});

    const allPrices = points.map(p => p.price).filter(p => p > 0);
    const minP = Math.min(...allPrices) * 0.998;
    const maxP = Math.max(...allPrices) * 1.002;
    const range = maxP - minP || 1;

    html += `<div style="margin-bottom:20px"><div style="font-size:.85rem;font-weight:600;margin-bottom:8px">${sym}</div>`;
    html += '<div class="dca-viz">';
    html += '<div class="dca-price-axis"></div>';
    html += '<div style="position:relative;flex:1">';
    points.forEach(pt => {
      if (pt.price <= 0) return;
      const topPct = ((maxP - pt.price) / range * 100);
      const lineStyle = pt.type === 'current' ? 'height:3px' : pt.type === 'tp' ? 'height:2px' : 'height:1px';
      const opacity = pt.type === 'unfilled' ? 'opacity:.4' : '';
      html += `<div class="dca-layer" style="top:${topPct}%;${opacity}">
        <div class="dca-layer-dot" style="background:${pt.color}"></div>
        <div class="dca-layer-line" style="background:${pt.color};${lineStyle}"></div>
        <div class="dca-layer-label" style="color:${pt.color}">${pt.label}</div>
      </div>`;
    });
    html += '</div></div></div>';
  });
  $('dcaLayerContent').innerHTML = html;
}

// ‚îÄ‚îÄ Manual Controls Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _confirmState = {};
function ctrlCmd(cmdObj, label, isDanger) {
  const key = JSON.stringify(cmdObj);
  if (isDanger && !_confirmState[key]) {
    _confirmState[key] = true;
    setTimeout(() => delete _confirmState[key], 5000);
    // Re-render to show confirm state
    if (status) renderManualControls(status);
    return;
  }
  delete _confirmState[key];
  // Copy command and also show PowerShell one-liner
  const acctDir = ACCOUNT_ID.replace('paper-', '');
  const jsonStr = JSON.stringify([cmdObj]);
  const psCmd = `echo '${jsonStr}' > trading/spot/paper/${acctDir}/commands.json`;
  navigator.clipboard.writeText(psCmd).then(() => {
    showCmdToast('üìã ' + label);
  }).catch(() => {
    prompt('Copy this command:', psCmd);
  });
  if (status) renderManualControls(status);
}

function renderManualControls(s) {
  if (!s) return;
  const ctrl = s.controls || {};
  const paused = ctrl.account_paused || false;
  const pausedCoins = new Set(ctrl.paused_coins || []);
  const convOverrides = ctrl.conviction_overrides || {};
  const soAdj = ctrl.max_so_adjustments || {};
  const skipSO = new Set(ctrl.skip_next_so || []);

  let html = '<div class="ctrl-section">';
  // Account controls
  html += '<div class="ctrl-row">';
  html += `<span class="ctrl-label" style="font-weight:700;font-size:.85rem">Account:</span>`;
  html += `<span class="badge ${paused ? 'badge-amber' : 'badge-green'}" style="font-size:.75rem">${paused ? '‚è∏ Paused' : '‚ñ∂ Running'}</span>`;
  if (paused) {
    html += `<button class="ctrl-btn ctrl-btn-safe" onclick="ctrlCmd({action:'resume_account'},'Resume Account')">‚ñ∂ Resume</button>`;
  } else {
    html += `<button class="ctrl-btn ctrl-btn-warn" onclick="ctrlCmd({action:'pause_account'},'Pause Account')">‚è∏ Pause</button>`;
  }
  const emergKey = JSON.stringify({action:'emergency_exit'});
  const emergConfirming = _confirmState[emergKey];
  html += `<button class="ctrl-btn ctrl-btn-danger${emergConfirming ? ' confirming' : ''}" onclick="ctrlCmd({action:'emergency_exit'},'Emergency Exit',true)">${emergConfirming ? '‚ö†Ô∏è Click again to confirm' : 'üõë Emergency Exit'}</button>`;
  html += '</div></div>';

  // Per-coin controls
  const symbols = s.symbols || Object.keys(s.coins || {});
  symbols.forEach(sym => {
    const c = (s.coins || {})[sym];
    const isPaused = pausedCoins.has(sym);
    const hasConvOverride = sym in convOverrides;
    const convVal = convOverrides[sym] || '';
    const soAdjVal = soAdj[sym] || 0;
    const willSkip = skipSO.has(sym);
    const state = c ? c.state : 'IDLE';
    const layers = c ? c.layers : 0;

    html += `<div class="ctrl-section">`;
    html += `<div class="ctrl-row" style="margin-bottom:10px">`;
    html += `<span style="font-weight:700;font-size:.9rem">${sym}</span>`;
    html += `<span class="badge ${isPaused ? 'badge-amber' : 'badge-green'}" style="font-size:.7rem">${isPaused ? '‚è∏ Paused' : '‚ñ∂ Active'} (${state}, Layer ${layers})</span>`;
    html += '</div>';

    // Row 1: Pause/Resume, Force Close, Skip SO
    html += '<div class="ctrl-row">';
    if (isPaused) {
      html += `<button class="ctrl-btn ctrl-btn-safe" onclick="ctrlCmd({action:'resume_coin',symbol:'${sym}'},'Resume ${sym}')">‚ñ∂ Resume</button>`;
    } else {
      html += `<button class="ctrl-btn ctrl-btn-warn" onclick="ctrlCmd({action:'pause_coin',symbol:'${sym}'},'Pause ${sym}')">‚è∏ Pause</button>`;
    }
    const fcKey = JSON.stringify({action:'force_close',symbol:sym});
    const fcConfirm = _confirmState[fcKey];
    html += `<button class="ctrl-btn ctrl-btn-danger${fcConfirm ? ' confirming' : ''}" onclick="ctrlCmd({action:'force_close',symbol:'${sym}'},'Force Close ${sym}',true)">${fcConfirm ? '‚ö†Ô∏è Confirm?' : 'Force Close'}</button>`;
    html += `<button class="ctrl-btn ${willSkip ? 'ctrl-btn-warn' : 'ctrl-btn-safe'}" onclick="ctrlCmd({action:'skip_next_so',symbol:'${sym}'},'Skip Next SO ${sym}')">${willSkip ? '‚è≠ Skip Queued' : '‚è≠ Skip Next SO'}</button>`;
    html += '</div>';

    // Row 2: Conviction Override
    html += '<div class="ctrl-row">';
    html += `<span class="ctrl-label">Conviction: ${hasConvOverride ? convVal + ' (override)' : 'auto'}</span>`;
    html += `<input class="ctrl-input" type="number" min="0" max="100" id="convInput_${sym.replace('/','_')}" value="${hasConvOverride ? convVal : ''}" placeholder="0-100">`;
    html += `<button class="ctrl-btn ctrl-btn-safe" onclick="var v=document.getElementById('convInput_${sym.replace('/','_')}').value;if(v)ctrlCmd({action:'override_conviction',symbol:'${sym}',score:Number(v)},'Override Conviction ${sym}')">Set</button>`;
    if (hasConvOverride) {
      html += `<button class="ctrl-btn ctrl-btn-warn" onclick="ctrlCmd({action:'clear_conviction_override',symbol:'${sym}'},'Clear Override ${sym}')">Clear</button>`;
    }
    html += '</div>';

    // Row 3: Max SO adjustment
    const effectiveMaxSO = 8 + soAdjVal; // approximate base
    html += '<div class="ctrl-row">';
    html += `<span class="ctrl-label">Max SOs: ${effectiveMaxSO} ${soAdjVal !== 0 ? '(' + (soAdjVal > 0 ? '+' : '') + soAdjVal + ' adj)' : ''}</span>`;
    html += `<button class="ctrl-btn ctrl-btn-safe" onclick="ctrlCmd({action:'adjust_max_sos',symbol:'${sym}',delta:1},'Max SO +1 ${sym}')">+</button>`;
    html += `<button class="ctrl-btn ctrl-btn-warn" onclick="ctrlCmd({action:'adjust_max_sos',symbol:'${sym}',delta:-1},'Max SO -1 ${sym}')">‚àí</button>`;
    if (soAdjVal !== 0) {
      html += `<button class="ctrl-btn ctrl-btn-warn" onclick="ctrlCmd({action:'reset_max_sos',symbol:'${sym}'},'Reset Max SO ${sym}')">Reset</button>`;
    }
    html += '</div>';

    html += '</div>';
  });

  $('manualControlsContent').innerHTML = html;
}

function renderRiskProfile(s) {
  if (!s) return;
  const section = $('riskProfileSection');
  const profile = (s.profile || 'medium').toLowerCase();
  const profileLabel = profile.charAt(0).toUpperCase() + profile.slice(1);
  const profileColors = {low:'var(--green)',medium:'var(--amber)',high:'var(--red)'};
  const profileBg = {low:'rgba(63,185,80,.15)',medium:'rgba(210,153,34,.15)',high:'rgba(248,81,73,.15)'};
  const color = profileColors[profile] || 'var(--text2)';
  const bg = profileBg[profile] || 'rgba(139,148,158,.15)';

  // Profile params (typical defaults per profile)
  const profileParams = {
    low:    {leverage:'1√ó',maxSOs:5,reserve:'30%',baseTP:'1.0%',baseDev:'3.0%'},
    medium: {leverage:'1√ó',maxSOs:8,reserve:'15%',baseTP:'1.1%',baseDev:'3.0%'},
    high:   {leverage:'1√ó',maxSOs:12,reserve:'5%',baseTP:'1.5%',baseDev:'2.5%'}
  };
  const params = profileParams[profile] || profileParams.medium;

  // Conviction-adjusted params (from first coin's conviction data)
  const firstConv = s.conviction ? Object.values(s.conviction)[0] : null;
  const effTP = firstConv ? (parseFloat(params.baseTP) * firstConv.tp_mult).toFixed(2) + '%' : params.baseTP;
  const effDev = firstConv ? (parseFloat(params.baseDev) * firstConv.dev_mult).toFixed(2) + '%' : params.baseDev;
  const effSOMult = firstConv ? fmt(firstConv.so_mult, 3) + '√ó' : '1.000√ó';

  // Regime + trend
  const regime = s.regime || '--';
  const trend = s.trend_direction || '--';
  const trendColor = trend === 'bullish' ? 'var(--green)' : trend === 'bearish' ? 'var(--red)' : 'var(--text2)';
  const trendArrow = trend === 'bullish' ? '‚ñ≤' : trend === 'bearish' ? '‚ñº' : '‚Äî';

  section.style.display = '';
  $('riskProfileContent').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Left: Profile + Params -->
      <div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <span style="font-size:1.4rem;font-weight:800;padding:8px 20px;border-radius:8px;background:${bg};color:${color};letter-spacing:.5px">${profileLabel}</span>
          <span style="font-size:.75rem;color:var(--text2)">Risk Profile</span>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Leverage</div>
            <div style="font-size:1rem;font-weight:600">${params.leverage}</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Max SOs</div>
            <div style="font-size:1rem;font-weight:600">${params.maxSOs}</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Reserve</div>
            <div style="font-size:1rem;font-weight:600">${params.reserve}</div>
          </div>
        </div>
        <div style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Eff. TP</div>
            <div style="font-size:1rem;font-weight:600;color:var(--green)">${effTP}</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Eff. Dev</div>
            <div style="font-size:1rem;font-weight:600;color:var(--amber)">${effDev}</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--bg);border-radius:6px;border:1px solid var(--border)">
            <div style="font-size:.6rem;color:var(--text3);text-transform:uppercase;margin-bottom:4px">SO Mult</div>
            <div style="font-size:1rem;font-weight:600;color:var(--blue)">${effSOMult}</div>
          </div>
        </div>
        ${firstConv ? '<div style="font-size:.6rem;color:var(--text3);margin-top:6px;text-align:center">‚Üë Adjusted by conviction scoring</div>' : ''}
      </div>
      <!-- Right: Regime + Trend -->
      <div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <span style="font-size:.75rem;color:var(--text2)">Market Conditions</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div style="padding:16px;background:var(--bg);border-radius:8px;border:1px solid var(--border);text-align:center">
            <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Regime</div>
            <div style="font-size:1.2rem;font-weight:700;margin-bottom:4px">${regimeBadge(regime, false)}</div>
            <div style="font-size:.68rem;color:var(--text3);line-height:1.3;margin-top:6px">${REGIME_DESCRIPTIONS[regime] || ''}</div>
          </div>
          <div style="padding:16px;background:var(--bg);border-radius:8px;border:1px solid var(--border);text-align:center">
            <div style="font-size:.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Trend</div>
            <div style="font-size:2rem;font-weight:800;color:${trendColor}">${trendArrow}</div>
            <div style="font-size:.85rem;font-weight:600;color:${trendColor};text-transform:capitalize;margin-top:4px">${trend}</div>
          </div>
        </div>
      </div>
    </div>`;
}

function renderSpotCoinSelector(s) {
  if (!s || !s.coins) return;
  const coins = s.coins;
  const coinKeys = Object.keys(coins);
  const section = $('spotCoinSelectorSection');
  section.style.display = '';
  $('spotCoinCount').textContent = `(${coinKeys.length})`;

  let html = '';
  coinKeys.forEach(sym => {
    const c = coins[sym];
    const stateColors = {ACCUMULATING:'var(--blue)',IDLE:'var(--text2)',WAITING:'var(--text2)',WINDING_DOWN:'var(--amber)'};
    const stateColor = stateColors[c.state] || 'var(--text2)';
    const pnlColor = pctColor(c.unrealized_pnl);
    const conv = s.conviction ? s.conviction[sym] : null;
    const convScore = conv ? fmt(conv.score, 1) : '--';
    const convColor = conv ? (conv.score >= 70 ? 'var(--green)' : conv.score >= 40 ? 'var(--amber)' : 'var(--red)') : 'var(--text2)';

    html += `<div class="coin-mini-card">
      <div class="coin-header">
        <span class="coin-symbol">${sym.split('/')[0]}</span>
        <span class="coin-score" style="color:${convColor}">Conviction: ${convScore}</span>
      </div>
      <div class="coin-details">
        <span class="badge" style="background:${stateColor}22;color:${stateColor}">${c.state || 'IDLE'}</span>
        <span>Layers: ${c.layers || 0}</span>
        <span style="color:${pnlColor}">PnL: ${fmtUsd(c.unrealized_pnl)}</span>
      </div>
      <div style="font-size:.68rem;color:var(--text3);margin-top:6px">Invested: ${fmtUsd(c.invested)} ¬∑ Entry: ${fmtUsd(c.avg_entry, 2)}</div>
    </div>`;
  });
  $('spotCoinSelectorGrid').innerHTML = html;
}

function renderConviction(s) {
  if (!s.conviction || !s.conviction_enabled) {
    $('convictionSection').style.display = 'none';
    return;
  }
  $('convictionSection').style.display = '';
  let html = '';
  Object.entries(s.conviction).forEach(([sym, c]) => {
    const score = c.score || 0;
    const band = (c.band || 'unknown').toUpperCase();
    // Color by score
    const scoreColor = score >= 70 ? 'var(--green)' : score >= 40 ? 'var(--amber)' : 'var(--red)';
    const bandColor = band === 'HIGH' ? 'var(--green)' : band === 'MODERATE' ? 'var(--amber)' : 'var(--red)';

    // SVG gauge arc
    const angle = (score / 100) * 180;
    const rad = angle * Math.PI / 180;
    const cx = 100, cy = 95, r = 75;
    const x1 = cx - r, y1 = cy;
    const x2 = cx - r * Math.cos(rad), y2 = cy - r * Math.sin(rad);
    const largeArc = angle > 90 ? 1 : 0;

    html += `<div style="margin-bottom:24px">
      <div style="font-size:.85rem;font-weight:600;margin-bottom:12px">${sym}</div>
      <div class="conviction-gauge">
        <svg viewBox="0 0 200 120">
          <!-- Background arc -->
          <path d="M 25 95 A 75 75 0 0 1 175 95" fill="none" stroke="#21262d" stroke-width="14" stroke-linecap="round"/>
          <!-- Score arc -->
          <path d="M ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2.toFixed(1)} ${y2.toFixed(1)}" fill="none" stroke="${scoreColor}" stroke-width="14" stroke-linecap="round"/>
          <!-- Score text -->
          <text x="100" y="80" class="conviction-score-text" fill="${scoreColor}">${fmt(score,1)}</text>
          <text x="100" y="108" class="conviction-band-text" fill="${bandColor}">${band}</text>
        </svg>
      </div>
      <div class="conviction-breakdown">
        <div class="conviction-item">
          <div class="conviction-item-label">Macro</div>
          <div class="conviction-item-value" style="color:var(--blue)">${fmt(c.macro,1)}</div>
          <div style="font-size:.6rem;color:var(--text3)">/ 40 max</div>
        </div>
        <div class="conviction-item">
          <div class="conviction-item-label">Regime</div>
          <div class="conviction-item-value" style="color:var(--purple)">${fmt(c.regime,1)}</div>
          <div style="font-size:.6rem;color:var(--text3)">/ 30 max</div>
        </div>
        <div class="conviction-item">
          <div class="conviction-item-label">Momentum</div>
          <div class="conviction-item-value" style="color:var(--amber)">${fmt(c.momentum,1)}</div>
          <div style="font-size:.6rem;color:var(--text3)">/ 30 max</div>
        </div>
      </div>
      <div class="conviction-multipliers">
        <div class="conviction-mult"><div class="conviction-mult-label">TP Mult</div><div class="conviction-mult-value" style="color:var(--green)">${fmt(c.tp_mult,2)}√ó</div></div>
        <div class="conviction-mult"><div class="conviction-mult-label">Dev Mult</div><div class="conviction-mult-value" style="color:var(--amber)">${fmt(c.dev_mult,2)}√ó</div></div>
        <div class="conviction-mult"><div class="conviction-mult-label">SO Mult</div><div class="conviction-mult-value" style="color:var(--blue)">${fmt(c.so_mult,3)}√ó</div></div>
        <div class="conviction-mult"><div class="conviction-mult-label">Max SO Adj</div><div class="conviction-mult-value" style="color:var(--purple)">${c.max_so_adj >= 0 ? '+' : ''}${c.max_so_adj}</div></div>
      </div>
    </div>`;
  });
  $('convictionContent').innerHTML = html;
}

function renderMacro(s) {
  if (!s.macro) { $('macroSection').style.display = 'none'; return; }
  $('macroSection').style.display = '';
  const m = s.macro;
  const fg = m.fear_greed || 0;
  // F&G color scale
  const fgColor = fg <= 20 ? '#f85149' : fg <= 40 ? '#d29922' : fg <= 60 ? '#e6edf3' : fg <= 80 ? '#3fb950' : '#3fb950';
  const fgLabel = fg <= 20 ? 'Extreme Fear' : fg <= 40 ? 'Fear' : fg <= 60 ? 'Neutral' : fg <= 80 ? 'Greed' : 'Extreme Greed';
  const fgPos = Math.max(2, Math.min(98, fg));

  const btcDist = m.btc_sma200_dist || 0;
  const btcColor = btcDist > 0 ? 'var(--green)' : btcDist > -20 ? 'var(--amber)' : 'var(--red)';

  const piGap = m.pi_cycle_gap || 0;
  const piColor = piGap > -10 ? 'var(--red)' : piGap > -30 ? 'var(--amber)' : 'var(--green)';

  $('macroContent').innerHTML = `
    <div class="macro-card">
      <div class="macro-card-label">Fear & Greed Index</div>
      <div class="macro-card-value" style="color:${fgColor}">${fg}</div>
      <div class="macro-card-sub">${fgLabel}</div>
      <div class="fg-bar"></div>
      <div style="position:relative"><div class="fg-indicator" style="margin-left:calc(${fgPos}% - 6px);background:${fgColor}"></div></div>
    </div>
    <div class="macro-card">
      <div class="macro-card-label">BTC vs SMA200</div>
      <div class="macro-card-value" style="color:${btcColor}">${fmt(btcDist,1)}%</div>
      <div class="macro-card-sub">${btcDist > 0 ? 'Above 200-day MA' : 'Below 200-day MA'}</div>
    </div>
    <div class="macro-card">
      <div class="macro-card-label">Pi Cycle Gap</div>
      <div class="macro-card-value" style="color:${piColor}">${fmt(piGap,1)}%</div>
      <div class="macro-card-sub">${piGap > -10 ? 'Near convergence ‚ö†Ô∏è' : piGap > -30 ? 'Moderate gap' : 'Wide gap ‚Äî no top signal'}</div>
    </div>`;
}

function renderSpotCoins(s) {
  if (!s.coins) return;
  let html = '';
  Object.entries(s.coins).forEach(([sym, c]) => {
    const stateColors = {ACCUMULATING:'var(--blue)',WAITING:'var(--text2)',WINDING_DOWN:'var(--amber)'};
    const stateColor = stateColors[c.state] || 'var(--text2)';
    const pnlColor = pctColor(c.unrealized_pnl);

    // Layer progress bar
    const maxLayers = 8; // typical max
    const layerPct = Math.min(100, (c.layers / maxLayers) * 100);

    // Price position between SO and TP
    const priceRange = (c.next_tp_price || 0) - (c.next_so_price || 0);
    const pricePos = priceRange > 0 ? ((c.current_price - c.next_so_price) / priceRange * 100) : 50;
    const clampedPos = Math.max(2, Math.min(98, pricePos));

    html += `<div class="spot-coin-card">
      <div class="spot-coin-header">
        <div>
          <span class="spot-coin-symbol">${sym}</span>
          <span class="badge badge-blue" style="margin-left:8px">${c.side?.toUpperCase() || 'LONG'}</span>
        </div>
        <span class="spot-coin-state badge" style="background:${stateColor}22;color:${stateColor};font-size:.75rem">${c.state || '--'}</span>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:16px">
        <div class="deal-stat"><div class="deal-stat-label">Current Price</div><div class="deal-stat-value">${fmtUsd(c.current_price, 2)}</div></div>
        <div class="deal-stat"><div class="deal-stat-label">Avg Entry</div><div class="deal-stat-value">${fmtUsd(c.avg_entry, 2)}</div></div>
        <div class="deal-stat"><div class="deal-stat-label">Invested</div><div class="deal-stat-value">${fmtUsd(c.invested)}</div></div>
        <div class="deal-stat"><div class="deal-stat-label">Layers</div><div class="deal-stat-value">${c.layers} / ${maxLayers}</div></div>
        <div class="deal-stat"><div class="deal-stat-label">Unrealized PnL</div><div class="deal-stat-value" style="color:${pnlColor}">${fmtUsd(c.unrealized_pnl)}</div></div>
        <div class="deal-stat"><div class="deal-stat-label">Realized PnL</div><div class="deal-stat-value" style="color:${pctColor(c.realized_pnl)}">${fmtUsd(c.realized_pnl)}</div></div>
      </div>

      <!-- Price position bar -->
      <div style="font-size:.65rem;color:var(--text2);margin-bottom:4px;display:flex;justify-content:space-between">
        <span>Next SO: ${fmtUsd(c.next_so_price, 2)}</span>
        <span>Next TP: ${fmtUsd(c.next_tp_price, 2)}</span>
      </div>
      <div class="deal-progress" style="height:24px">
        <div class="deal-progress-fill" style="width:${clampedPos}%;background:linear-gradient(90deg,rgba(248,81,73,.2),rgba(63,185,80,.3))"></div>
        <div class="deal-marker" style="left:0%"><div class="deal-marker-dot" style="background:var(--red);opacity:.6"></div></div>
        <div class="deal-marker" style="left:100%"><div class="deal-marker-dot" style="background:var(--green)"></div></div>
        <div class="deal-marker deal-current" style="left:${clampedPos}%"><div class="deal-marker-dot"></div></div>
      </div>

      <!-- Layer progress -->
      <div style="margin-top:12px">
        <div style="font-size:.65rem;color:var(--text2);margin-bottom:4px">Layer Accumulation: ${c.layers} of ${maxLayers}</div>
        <div class="adaptive-meter" style="height:10px"><div class="adaptive-meter-fill" style="width:${layerPct}%;background:var(--blue)"></div></div>
      </div>
    </div>`;
  });
  $('spotCoinsContent').innerHTML = html;
}

function renderSentiment(s) {
  if (!s.sentiment) { $('sentimentSection').style.display = 'none'; return; }
  $('sentimentSection').style.display = '';
  let html = '';
  Object.entries(s.sentiment).forEach(([sym, sent]) => {
    const scoreColor = sent.score > 50 ? 'var(--green)' : sent.score > 25 ? 'var(--amber)' : 'var(--red)';
    html += `<div class="sentiment-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <span style="font-weight:600">${sym}</span>
        <div style="display:flex;gap:12px;font-size:.75rem">
          <span>Score: <span style="color:${scoreColor};font-weight:700">${sent.score}</span></span>
          <span>Exit Pressure: <span style="font-weight:600">${sent.exit_pressure}</span></span>
          <span>TP Mult: <span style="font-weight:600">${fmt(sent.tp_multiplier, 1)}√ó</span></span>
        </div>
      </div>
      <div class="sentiment-narrative">"${sent.narrative || 'No narrative available'}"</div>
      ${sent.updated ? `<div style="font-size:.6rem;color:var(--text3);margin-top:6px">Updated: ${new Date(sent.updated).toLocaleString()}</div>` : ''}
    </div>`;
  });
  $('sentimentContent').innerHTML = html;
}

function renderSpotDeals(s) {
  // For spot, the deal section shows a summary
  $('dealTitle').textContent = 'Position Summary';
  const coins = Object.entries(s.coins || {});
  if (!coins.length) {
    $('dealContent').innerHTML = '<div class="no-deal">No active positions</div>';
    return;
  }
  $('dealContent').innerHTML = '<div class="no-deal" style="color:var(--text2);font-size:.8rem">See coin positions above for detailed view</div>';
}

function renderSpotBottom(s) {
  const coins = Object.values(s.coins || {});
  const totalInvested = coins.reduce((a,c) => a + (c.invested||0), 0);
  const symbols = Object.keys(s.coins || {}).map(s => s.split('/')[0]);
  $('bTrading').innerHTML = symbols.map(s => `<span class="badge badge-blue" style="font-size:.7rem">${s}</span>`).join(' ');
  $('bAvgProfit').textContent = fmtUsd(s.total_realized_pnl || 0);
  $('bAvgProfit').previousElementSibling.textContent = 'Realized PnL';
  $('bAvgDur').textContent = s.deals_completed || 0;
  $('bAvgDur').previousElementSibling.textContent = 'Deals Done';
  $('bAvgSO').textContent = coins.reduce((a,c) => a + (c.layers||0), 0);
  $('bAvgSO').previousElementSibling.textContent = 'Total Layers';
  if (s.uptime_hours) $('bUptime').textContent = fmt(s.uptime_hours,1) + 'h';
  const dd = s.max_drawdown_pct || 0;
  $('bDD').textContent = fmt(dd) + '%';
  const ddBar = $('bDDBar');
  ddBar.style.width = Math.min(dd/25*100,100) + '%';
  ddBar.style.background = dd > 15 ? 'var(--red)' : dd > 5 ? 'var(--amber)' : 'var(--green)';
  $('bReserve').textContent = fmtUsd(s.cash || 0);
  $('bReserve').previousElementSibling.textContent = 'Cash';

  // Capital utilization donut
  const totalCap = s.capital || 10000;
  const cash = s.cash || 0;
  const utilPct = totalCap > 0 ? ((totalCap - cash) / totalCap * 100) : 0;
  $('cCapUtilLg').innerHTML = `<span style="color:${utilPct>60?'var(--green)':utilPct>30?'var(--amber)':'var(--text)'}">${fmt(utilPct,1)}%</span>`;
  $('capActive').innerHTML = `<span style="color:var(--blue)">${fmtUsd(totalInvested)}</span>`;
  $('capPending').innerHTML = `<span style="color:var(--amber)">${fmtUsd(0)}</span>`;
  $('capAvailable').textContent = fmtUsd(cash);

  // Donut
  const cvs = $('capDonutLg');
  if (cvs) {
    const dctx = cvs.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const donutSize = 220;
    cvs.width = donutSize * dpr; cvs.height = donutSize * dpr;
    cvs.style.width = donutSize + 'px'; cvs.style.height = donutSize + 'px';
    dctx.scale(dpr, dpr);
    const cx = donutSize/2, cy = donutSize/2, r2 = 82, lw = 22;
    dctx.clearRect(0, 0, donutSize, donutSize);
    dctx.beginPath(); dctx.arc(cx, cy, r2, 0, Math.PI * 2);
    dctx.strokeStyle = '#21262d'; dctx.lineWidth = lw; dctx.stroke();
    if (totalCap > 0) {
      let angle = -Math.PI / 2;
      const sweep = (totalInvested / totalCap) * Math.PI * 2;
      if (sweep > 0) {
        dctx.beginPath(); dctx.arc(cx, cy, r2, angle, angle + sweep);
        dctx.strokeStyle = '#58a6ff'; dctx.lineWidth = lw; dctx.lineCap = 'butt'; dctx.stroke();
      }
    }
    dctx.fillStyle = '#e6edf3'; dctx.font = 'bold 32px system-ui'; dctx.textAlign = 'center'; dctx.textBaseline = 'middle';
    dctx.fillText(fmt(utilPct, 0) + '%', donutSize/2, donutSize/2);
  }
}

// ‚îÄ‚îÄ Futures Rendering (unchanged from original) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStatus() {
  if(!status) return;
  const s = status;
  $('symbolBadge').textContent = s.symbol + ' ' + s.timeframe;
  const dot = $('statusDot');
  dot.className = 'status-dot ' + (s.halted ? 'halted' : s.running ? 'running' : 'stopped');
  $('statusLabel').textContent = s.halted ? 'HALTED' : s.running ? 'Running' : 'Stopped';

  if (s.last_update) {
    const d = new Date(s.last_update);
    const ago = Math.round((Date.now() - d.getTime()) / 60000);
    $('lastUpdated').textContent = 'Updated ' + (ago < 60 ? ago+'m ago' : Math.round(ago/60)+'h ago');
  }

  $('cEquity').textContent = fmtUsd(s.equity);
  const deposits = s.total_deposits || 0;
  const tradingBase = s.start_equity + deposits;
  const tradingPnl = s.equity - tradingBase;

  const alloc = s.regime_alloc;
  if (alloc) {
    const directionalRegimes = ['TRENDING', 'MILD_TREND', 'DISTRIBUTION'];
    const isDirectional = directionalRegimes.includes(s.regime) && s.trend_direction;
    const dirNote = isDirectional ? ` <span style="font-size:.6rem;color:var(--text3)">(${s.trend_direction === 'bullish' ? '‚ñ≤' : '‚ñº'} adjusted)</span>` : '';
    $('allocBadge').innerHTML = `Alloc: <span class="alloc-long">${Math.round(alloc.long*100)}% L</span> / <span class="alloc-short">${Math.round(alloc.short*100)}% S</span>${dirNote}`;
  }

  const tpTrades = trades.filter(t => t.action === 'TP_HIT');
  const realPnl = tpTrades.reduce((a,t) => a + parseFloat(t.pnl||0), 0);
  $('cRealPnl').innerHTML = `<span style="color:${pctColor(realPnl)}">${fmtUsd(realPnl)}</span>`;
  $('cRealPnlSub').textContent = tpTrades.length + ' closed trade' + (tpTrades.length!==1?'s':'');

  const activeDeals = getActiveDeals(s);
  let totalUnreal = 0, totalCost = 0;
  activeDeals.forEach(d => { totalUnreal += calcUnreal(d, s.price); totalCost += d.total_cost || 0; });
  $('cUnrealPnl').innerHTML = `<span style="color:${pctColor(totalUnreal)}">${fmtUsd(totalUnreal)}</span>`;
  const unrealPct = totalCost > 0 ? (totalUnreal / totalCost * 100) : 0;
  $('cUnrealPnlSub').innerHTML = `<span style="color:${pctColor(unrealPct)}">${unrealPct>=0?'+':''}${fmt(unrealPct)}%</span>`;

  const fundingFees = s.total_funding_fees || 0;
  const fundingColor = fundingFees > 0 ? 'var(--green)' : 'var(--red)';
  $('cFunding').innerHTML = `<span style="color:${fundingColor}">${fmtUsd(fundingFees)}</span>`;
  const currentRate = s.current_funding_rate || 0;
  const rateDirection = currentRate > 0 ? 'longs pay' : currentRate < 0 ? 'shorts pay' : 'neutral';
  const ratePct = (currentRate * 100).toFixed(4);
  $('cFundingSub').innerHTML = `Current: ${ratePct}% ‚Üí ${rateDirection}`;
  if ($('cFundingTotal')) {
    $('cFundingTotal').innerHTML = `<span style="color:${fundingColor}">${fmtUsd(fundingFees)}</span>`;
    $('cFundingRate').innerHTML = `${ratePct}% ‚Üí ${rateDirection}`;
  }

  const grossPnl = tradingPnl;
  const netAfterFunding = grossPnl + fundingFees;
  $('cEquitySub').innerHTML = `Trading: <span style="color:${pctColor(grossPnl)}">${grossPnl>=0?'+':''}${fmtUsd(grossPnl)}</span> | Funding: <span style="color:${fundingColor}">${fundingFees>=0?'+':''}${fmtUsd(fundingFees)}</span> | Net: <span style="color:${pctColor(netAfterFunding)}">${netAfterFunding>=0?'+':''}${fmtUsd(netAfterFunding)}</span>` + (deposits > 0 ? `<br><span style="color:var(--text3);font-size:.65rem">Start: ${fmtUsd(s.start_equity)} + ${fmtUsd(deposits)} deposited</span>` : '');

  const wins = tpTrades.filter(t => parseFloat(t.pnl) > 0).length;
  const losses = tpTrades.filter(t => parseFloat(t.pnl) <= 0).length;
  $('cWinLoss').innerHTML = `<span style="color:var(--green)">${wins}W</span> / <span style="color:var(--red)">${losses}L</span>`;
  $('cWinLossSub').textContent = (wins+losses) + ' total trades';

  const total = wins + losses;
  if(total === 0) {
    $('cWinRate').innerHTML = '<span style="color:var(--text2)">&mdash;</span>';
    $('cWinRateSub').textContent = 'No closed trades';
  } else {
    const wr = wins/total*100;
    const wrc = wr > 80 ? 'var(--green)' : wr > 50 ? 'var(--amber)' : 'var(--red)';
    $('cWinRate').innerHTML = `<span style="color:${wrc}">${fmt(wr,1)}%</span>`;
    $('cWinRateSub').textContent = total + ' trades';
  }

  const dailyPnlROI = {};
  tpTrades.forEach(t => {
    const day = new Date(t.timestamp).toLocaleDateString('en-CA');
    dailyPnlROI[day] = (dailyPnlROI[day] || 0) + parseFloat(t.pnl || 0);
  });
  const roiDays = Object.keys(dailyPnlROI).sort();
  const startEq = s.start_equity || s.capital || 292;
  const totalRealPnl = tpTrades.reduce((a, t) => a + parseFloat(t.pnl || 0), 0);
  const totalROI = startEq > 0 ? (totalRealPnl / startEq * 100) : 0;
  const numDays = Math.max(1, roiDays.length);
  const avgDailyROI = totalROI / numDays;
  const todayStr = new Date().toLocaleDateString('en-CA');
  const todayPnl = dailyPnlROI[todayStr] || 0;
  const todayROI = startEq > 0 ? (todayPnl / startEq * 100) : 0;
  $('cAvgROI').innerHTML = `<span style="color:${pctColor(avgDailyROI)}">${avgDailyROI >= 0 ? '+' : ''}${fmt(avgDailyROI, 2)}%</span>`;
  $('cAvgROISub').innerHTML = `Today: <span style="color:${pctColor(todayROI)}">${todayROI >= 0 ? '+' : ''}${fmt(todayROI, 2)}%</span> (${fmtUsd(todayPnl)})`;

  renderAdaptivePanel(s);

  // Capital Utilization
  let activeCost = 0;
  activeDeals.forEach(d => { activeCost += d.total_cost || 0; });
  const totalCap = s.equity || s.capital || 292;
  const cfg = s.config || {};
  const boUsd = totalCap * (cfg.base_order_pct || 0.04);
  const soVolMult = cfg.so_vol_mult || 2.0;
  let pendingCost = 0;
  activeDeals.forEach(d => {
    const pendingSOs = (d.safety_order_ids || []).length;
    for (let i = 1; i <= pendingSOs; i++) {
      const soNum = d.safety_orders_filled + i;
      pendingCost += boUsd * Math.pow(soVolMult, soNum);
    }
  });
  const committed = activeCost + pendingCost;
  const available = Math.max(0, totalCap - committed);
  const utilPct = totalCap > 0 ? Math.min(100, committed / totalCap * 100) : 0;
  const utilColor = utilPct > 80 ? 'var(--green)' : utilPct > 40 ? 'var(--amber)' : 'var(--text)';
  $('cCapUtilLg').innerHTML = `<span style="color:${utilColor}">${fmt(utilPct,1)}%</span>`;
  $('capActive').innerHTML = `<span style="color:var(--blue)">${fmtUsd(activeCost)}</span>`;
  $('capPending').innerHTML = `<span style="color:var(--amber)">${fmtUsd(pendingCost)}</span>`;
  $('capAvailable').textContent = fmtUsd(available);

  // Donut
  const cvs = $('capDonutLg');
  const dctx = cvs.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const donutSize = 220;
  cvs.width = donutSize * dpr; cvs.height = donutSize * dpr;
  cvs.style.width = donutSize + 'px'; cvs.style.height = donutSize + 'px';
  dctx.scale(dpr, dpr);
  const cx = donutSize/2, cy = donutSize/2, r2 = 82, lw = 22;
  dctx.clearRect(0, 0, donutSize, donutSize);
  dctx.beginPath(); dctx.arc(cx, cy, r2, 0, Math.PI * 2);
  dctx.strokeStyle = '#21262d'; dctx.lineWidth = lw; dctx.stroke();
  const capTotal = activeCost + pendingCost + available;
  if (capTotal > 0) {
    let angle = -Math.PI / 2;
    [{val:activeCost,color:'#58a6ff'},{val:pendingCost,color:'#d29922'}].forEach(seg => {
      if (seg.val <= 0) return;
      const sweep = (seg.val / capTotal) * Math.PI * 2;
      dctx.beginPath(); dctx.arc(cx, cy, r2, angle, angle + sweep);
      dctx.strokeStyle = seg.color; dctx.lineWidth = lw; dctx.lineCap = 'butt'; dctx.stroke();
      angle += sweep;
    });
  }
  dctx.fillStyle = '#e6edf3'; dctx.font = 'bold 32px system-ui'; dctx.textAlign = 'center'; dctx.textBaseline = 'middle';
  dctx.fillText(fmt(utilPct, 0) + '%', cx, cy);

  $('bLeverage').textContent = (s.leverage || 1) + '√ó';
  $('bTrading').innerHTML = `<span class="badge badge-blue" style="font-size:.7rem">${(s.symbol || 'UNKNOWN').replace('USDT', '')}</span>`;

  renderDeal();
  renderOpenOrders();
  renderBottom();
}

function renderAdaptivePanel(s) {
  const atp = s.adaptive_tp;
  if (!atp) return;
  $('regimeDisplay').innerHTML = regimeBadge(s.regime, true);
  const directionalRegimes = ['TRENDING', 'MILD_TREND', 'DISTRIBUTION'];
  const baseDesc = REGIME_DESCRIPTIONS[s.regime] || '';
  const dirDesc = (directionalRegimes.includes(s.regime) && s.trend_direction)
    ? ` ¬∑ ${s.trend_direction === 'bullish' ? '‚ñ≤ Bullish' : '‚ñº Bearish'} trend`
    : '';
  $('regimeDesc').textContent = baseDesc + dirDesc;

  const tpRange = atp.tp_max - atp.tp_min;
  const tpPct = tpRange > 0 ? ((atp.current_tp_pct - atp.tp_min) / tpRange * 100) : 50;
  $('tpValue').textContent = fmt(atp.current_tp_pct, 2);
  $('tpMeter').style.width = Math.max(2, Math.min(100, tpPct)) + '%';
  $('tpMeter').style.background = tpPct < 30 ? 'var(--amber)' : tpPct > 70 ? 'var(--green)' : 'var(--blue)';
  $('tpMin').textContent = fmt(atp.tp_min, 1) + '%';
  $('tpMax').textContent = fmt(atp.tp_max, 1) + '%';

  const devRange = atp.dev_max - atp.dev_min;
  const devPct = devRange > 0 ? ((atp.current_dev_pct - atp.dev_min) / devRange * 100) : 50;
  $('devValue').textContent = fmt(atp.current_dev_pct, 2);
  $('devMeter').style.width = Math.max(2, Math.min(100, devPct)) + '%';
  $('devMeter').style.background = devPct < 30 ? 'var(--amber)' : devPct > 70 ? 'var(--green)' : 'var(--blue)';
  $('devMin').textContent = fmt(atp.dev_min, 1) + '%';
  $('devMax').textContent = fmt(atp.dev_max, 1) + '%';

  const atrRatio = atp.atr_baseline_pct > 0 ? (atp.atr_pct / atp.atr_baseline_pct) : 1;
  const atrLabel = atrRatio < 0.7 ? 'Low vol' : atrRatio > 1.3 ? 'High vol' : 'Normal';
  $('atrValue').textContent = fmt(atp.atr_pct, 3) + '%';
  $('atrLabel').textContent = atrLabel + ' (base: ' + fmt(atp.atr_baseline_pct, 1) + '%)';
  $('tpMultValue').innerHTML = `<span style="color:${atp.regime_tp_mult > 1 ? 'var(--green)' : atp.regime_tp_mult < 1 ? 'var(--amber)' : 'var(--text)'}">${fmt(atp.regime_tp_mult, 2)}√ó</span>`;
  $('devMultValue').innerHTML = `<span style="color:${atp.regime_dev_mult > 1 ? 'var(--green)' : atp.regime_dev_mult < 1 ? 'var(--amber)' : 'var(--text)'}">${fmt(atp.regime_dev_mult, 2)}√ó</span>`;
}

function renderSingleTrade(d, price, config) {
  const cfg = config || {};
  const tp = d.avg_entry * (1 + (d.direction==='LONG'?1:-1) * (cfg.tp_pct||4)/100);
  const soLevels = [];
  const maxSO = cfg.max_sos || 8;
  const dev = cfg.deviation_pct || 1.5;
  for(let i = d.safety_orders_filled + 1; i <= maxSO; i++) {
    const soPrice = d.direction === 'LONG' ? d.avg_entry * (1 - dev * i / 100) : d.avg_entry * (1 + dev * i / 100);
    soLevels.push(soPrice);
  }
  const allPrices = [d.entry_price, d.avg_entry, price, tp, ...soLevels];
  const minP = Math.min(...allPrices), maxP = Math.max(...allPrices);
  const range = maxP - minP || 1;
  const pct = v => ((v - minP) / range * 100);
  const fillColor = d.direction === 'LONG' ? 'rgba(63,185,80,.15),rgba(63,185,80,.3)' : 'rgba(248,81,73,.15),rgba(248,81,73,.3)';
  let html = `<div class="deal-progress"><div class="deal-progress-fill" style="width:${pct(price)}%;background:linear-gradient(90deg,${fillColor})"></div>`;
  soLevels.forEach((sp, i) => {
    html += `<div class="deal-marker" style="left:${pct(sp)}%"><div class="deal-marker-label" style="left:0">O${d.safety_orders_filled+i+1}</div><div class="deal-marker-dot" style="background:var(--red);opacity:.5"></div></div>`;
  });
  html += `<div class="deal-marker" style="left:${pct(d.entry_price)}%"><div class="deal-marker-label" style="left:0">Entry</div><div class="deal-marker-dot" style="background:var(--amber)"></div></div>`;
  html += `<div class="deal-marker" style="left:${pct(d.avg_entry)}%"><div class="deal-marker-label" style="left:0">Avg</div><div class="deal-marker-dot" style="background:var(--amber);opacity:.6"></div></div>`;
  html += `<div class="deal-marker" style="left:${pct(tp)}%"><div class="deal-marker-label" style="left:0">TP</div><div class="deal-marker-dot" style="background:var(--green)"></div></div>`;
  html += `<div class="deal-marker deal-current" style="left:${pct(price)}%"><div class="deal-marker-label" style="left:0;color:var(--blue)">Now</div><div class="deal-marker-dot"></div></div>`;
  html += '</div>';
  const unreal = calcUnreal(d, price);
  const dealTime = d.entry_time ? durStr(Date.now() - new Date(d.entry_time).getTime()) : '--';
  html += `<div class="deal-stats">
    <div class="deal-stat"><div class="deal-stat-label">Entry Price</div><div class="deal-stat-value">${fmtUsd(d.entry_price,3)}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">Avg Entry</div><div class="deal-stat-value">${fmtUsd(d.avg_entry,3)}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">Current Price</div><div class="deal-stat-value">${fmtUsd(price,3)}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">TP Target</div><div class="deal-stat-value" style="color:var(--green)">${fmtUsd(tp,3)}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">Quantity</div><div class="deal-stat-value">${d.total_qty}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">Invested</div><div class="deal-stat-value">${fmtUsd(d.total_cost)}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">Orders Filled</div><div class="deal-stat-value">${d.safety_orders_filled} / ${cfg.max_sos||8}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">Duration</div><div class="deal-stat-value">${dealTime}</div></div>
    <div class="deal-stat"><div class="deal-stat-label">Unrealized PnL</div><div class="deal-stat-value" style="color:${pctColor(unreal)}">${fmtUsd(unreal)}</div></div>
  </div>`;
  return html;
}

function renderOpenOrders() {
  if (!status) return;
  const s = status;
  const cfg = s.config || {};
  const boUsd = (s.capital || 292) * (cfg.base_order_pct || 0.04);
  const soVolMult = cfg.so_vol_mult || 2.0;
  const devPct = s.adaptive_tp?.current_dev_pct || cfg.deviation_pct || 2.5;
  const tpPct = s.adaptive_tp?.current_tp_pct || cfg.tp_pct || 1.5;
  const price = s.price || 0;
  const orders = [];
  const deals = getActiveDeals(s);
  deals.forEach(d => {
    if (d.tp_order_id) {
      const tp = d.direction === 'LONG' ? d.avg_entry * (1 + tpPct / 100) : d.avg_entry * (1 - tpPct / 100);
      const side = d.direction === 'LONG' ? 'SELL' : 'BUY';
      const dist = price > 0 ? ((tp - price) / price * 100) : 0;
      orders.push({ side, dir: d.direction, type: 'Take Profit', price: tp, qty: d.total_qty, size: tp * d.total_qty, dist, dealId: d.deal_id });
    }
    const pendingCount = (d.safety_order_ids || []).length;
    let cumQty = d.total_qty || 0, cumCost = d.total_cost || 0;
    for (let i = 1; i <= pendingCount; i++) {
      const soNum = d.safety_orders_filled + i;
      const soDeviation = devPct * soNum;
      const soPrice = d.direction === 'LONG' ? d.entry_price * (1 - soDeviation / 100) : d.entry_price * (1 + soDeviation / 100);
      const sizeUsd = boUsd * Math.pow(soVolMult, soNum);
      const qty = Math.round(sizeUsd / soPrice * 100) / 100;
      cumQty += qty; cumCost += qty * soPrice;
      const newAvg = cumCost / cumQty;
      const projTp = d.direction === 'LONG' ? newAvg * (1 + tpPct / 100) : newAvg * (1 - tpPct / 100);
      const side = d.direction === 'LONG' ? 'BUY' : 'SELL';
      const dist = price > 0 ? ((soPrice - price) / price * 100) : 0;
      orders.push({ side, dir: d.direction, type: `Order #${soNum}`, price: soPrice, projTp, qty, size: sizeUsd, dist, dealId: d.deal_id });
    }
  });
  orders.sort((a, b) => Math.abs(a.dist) - Math.abs(b.dist));
  $('openOrderCount').textContent = `(${orders.length})`;
  const body = $('openOrdersBody');
  if (!orders.length) { body.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:20px">No open orders</td></tr>'; return; }
  body.innerHTML = orders.map(o => {
    const sideClass = o.side === 'BUY' ? 'badge-green' : 'badge-red';
    const dirClass = o.dir === 'LONG' ? 'badge-green' : 'badge-red';
    const distColor = Math.abs(o.dist) < 2 ? 'var(--amber)' : 'var(--text2)';
    const projTpCell = o.projTp ? `<span style="color:var(--green)">${fmtUsd(o.projTp, 3)}</span>` : '--';
    const symbol = (status?.symbol || 'UNKNOWN').replace('USDT', '');
    return `<tr>
      <td><span class="badge ${sideClass}">${o.side}</span></td>
      <td><span class="badge badge-blue" style="font-size:.7rem">${symbol}</span></td>
      <td><span class="badge ${dirClass}">${o.dir}</span> #${o.dealId}</td>
      <td>${o.type}</td>
      <td>${fmtUsd(o.price, 3)}</td>
      <td>${projTpCell}</td>
      <td>${o.qty}</td>
      <td>${fmtUsd(o.size)}</td>
      <td style="color:${distColor}">${o.dist >= 0 ? '+' : ''}${fmt(o.dist, 2)}%</td>
    </tr>`;
  }).join('');
}

function renderDeal() {
  const s = status;
  const activeDeals = getActiveDeals(s);
  if(activeDeals.length === 0) {
    $('dealTitle').textContent = 'Active Trades';
    $('dealContent').innerHTML = '<div class="no-deal">No Active Trades ‚Äî Waiting for favorable regime...</div>';
    return;
  }
  $('dealTitle').textContent = 'Active Trades';
  const cfg = s.config || {};
  const isSingle = activeDeals.length === 1;
  let html = `<div class="trades-grid${isSingle ? ' single' : ''}">`;
  activeDeals.forEach(d => {
    const label = d.direction === 'LONG' ? 'LONG' : 'SHORT';
    const badgeClass = d.direction === 'LONG' ? 'badge-green' : 'badge-red';
    const symbol = (s.symbol || 'UNKNOWN').replace('USDT', '');
    html += `<div class="trade-panel"><div class="trade-panel-header"><span class="badge ${badgeClass}">${label}</span> ${symbol} #${d.deal_id}</div>${renderSingleTrade(d, s.price, cfg)}</div>`;
  });
  html += '</div>';
  $('dealContent').innerHTML = html;
}

function renderCharts() {
  if(!history.length) return;
  const labels = history.map(h => new Date(h.t));
  const equities = history.map(h => h.eq);
  const ctx1 = $('chartPriceEq').getContext('2d');
  if(chartPE) chartPE.destroy();
  chartPE = new Chart(ctx1, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Equity ($)', data: equities, borderColor: '#3fb950', backgroundColor: 'rgba(63,185,80,.1)', fill: true, pointRadius: 0, borderWidth: 2, tension: .3 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => '$' + ctx.parsed.y.toFixed(2) } } },
      scales: {
        x: { type: 'time', ticks: { color: '#484f58', maxTicksLimit: 6, font: { size: 10 } }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#3fb950', font: { size: 10 }, callback: v => '$'+v }, grid: { color: '#21262d' } }
      }
    }
  });
}

let tradePage = 0;

function renderTrades() {
  const tpTrades = trades.filter(t => t.action === 'TP_HIT');
  const ctx3 = $('chartTrades').getContext('2d');
  if(chartTrades) chartTrades.destroy();
  const dailyPnl = {}, dailyCount = {};
  tpTrades.forEach(t => {
    const day = new Date(t.timestamp).toLocaleDateString('en-CA');
    dailyPnl[day] = (dailyPnl[day] || 0) + parseFloat(t.pnl || 0);
    dailyCount[day] = (dailyCount[day] || 0) + 1;
  });
  const days = Object.keys(dailyPnl).sort();
  if(days.length > 0) {
    chartTrades = new Chart(ctx3, {
      type: 'bar',
      data: {
        labels: days,
        datasets: [{
          label: 'Daily PnL', data: days.map(d => dailyPnl[d]),
          backgroundColor: days.map(d => dailyPnl[d] >= 0 ? 'rgba(63,185,80,.7)' : 'rgba(248,81,73,.7)'),
          borderRadius: 3, yAxisID: 'y'
        },{
          label: 'Trades', data: days.map(d => dailyCount[d]),
          type: 'line', borderColor: '#58a6ff', backgroundColor: 'transparent',
          pointRadius: 3, pointBackgroundColor: '#58a6ff', borderWidth: 1.5, yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#8b949e', boxWidth: 12, font: { size: 11 } } } },
        scales: {
          x: { ticks: { color: '#484f58', font: { size: 10 } }, grid: { display: false } },
          y: { position: 'left', ticks: { color: '#3fb950', font: { size: 10 }, callback: v => '$'+v.toFixed(2) }, grid: { color: '#21262d' } },
          y1: { position: 'right', ticks: { color: '#58a6ff', font: { size: 10 }, stepSize: 1 }, grid: { display: false }, beginAtZero: true }
        }
      }
    });
  }
  renderTradesPage();
  if (!IS_SPOT) renderStatus();
}

function renderTradesPage() {
  const pageSize = parseInt($('tradePageSize').value) || 25;
  const allTrades = trades.slice().reverse();
  const totalPages = Math.max(1, Math.ceil(allTrades.length / pageSize));
  tradePage = Math.max(0, Math.min(tradePage, totalPages - 1));
  const start = tradePage * pageSize;
  const pageTrades = allTrades.slice(start, start + pageSize);
  $('tradeCount').textContent = `(${trades.length} entries)`;
  $('tradePageInfo').textContent = `Page ${tradePage + 1} of ${totalPages}`;
  $('tradePrev').disabled = tradePage === 0;
  $('tradeNext').disabled = tradePage >= totalPages - 1;
  $('tradePrev').style.opacity = tradePage === 0 ? '.4' : '1';
  $('tradeNext').style.opacity = tradePage >= totalPages - 1 ? '.4' : '1';
  const body = $('tradesBody');
  if(!pageTrades.length) { body.innerHTML = '<tr><td colspan="11" style="text-align:center;color:var(--text2);padding:20px">No trades yet</td></tr>'; return; }
  const dealOpens = {}, closedDeals = new Set();
  trades.forEach(t => { if(t.action==='OPEN') dealOpens[t.deal_id] = new Date(t.timestamp); });
  trades.forEach(t => { if(t.action==='TP_HIT') closedDeals.add(t.deal_id); });
  body.innerHTML = pageTrades.map(t => {
    const pnl = parseFloat(t.pnl||0);
    const pnlClass = pnl > 0 ? 'pnl-pos' : pnl < 0 ? 'pnl-neg' : '';
    const dur = (t.action === 'TP_HIT' && dealOpens[t.deal_id]) ? durStr(new Date(t.timestamp) - dealOpens[t.deal_id]) : '--';
    const time = new Date(t.timestamp);
    const timeStr = time.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' ' + time.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    const tpPct = status?.config?.tp_pct || 1.5;
    const entryPrice = parseFloat(t.price);
    const tpTarget = t.direction === 'LONG' || t.direction === 'long' ? entryPrice * (1 + tpPct/100) : entryPrice * (1 - tpPct/100);
    const showTp = (t.action === 'OPEN' || t.action === 'TP_HIT') ? `<span style="color:var(--green)">${fmtUsd(tpTarget,3)}</span>` : '--';
    const displayAction = t.action === 'OPEN' && closedDeals.has(t.deal_id) ? 'CLOSED' : t.action;
    const actionBadge = displayAction==='TP_HIT'?'badge-green':displayAction==='CLOSED'?'badge-gray':displayAction==='OPEN'?'badge-blue':displayAction==='SO_FILL'?'badge-amber':'badge-gray';
    const symbol = (t.symbol || (status?.symbol) || 'UNKNOWN').replace('USDT', '');
    return `<tr>
      <td>${timeStr}</td>
      <td><span class="badge badge-blue" style="font-size:.7rem">${symbol}</span></td>
      <td><span class="badge ${actionBadge}">${displayAction}</span></td>
      <td>${dirBadge(t.direction)}</td>
      <td>${fmtUsd(entryPrice,3)}</td>
      <td>${showTp}</td>
      <td>${t.qty}</td>
      <td>${dur}</td>
      <td>${t.so_count||'--'}</td>
      <td class="${pnlClass}">${pnl!==0?fmtUsd(pnl):'--'}</td>
      <td>${regimeBadge(t.regime)}</td>
    </tr>`;
  }).join('');
}

document.addEventListener('DOMContentLoaded', () => {
  $('tradePrev').addEventListener('click', () => { tradePage--; renderTradesPage(); });
  $('tradeNext').addEventListener('click', () => { tradePage++; renderTradesPage(); });
  $('tradePageSize').addEventListener('change', () => { tradePage = 0; renderTradesPage(); });
});

// ‚îÄ‚îÄ Portfolio Mode Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPortfolio() {
  const p = portfolioStatus;
  if(!p) return;
  const activeCoins = Object.values(p.coins).filter(c => c.status === 'active');
  const allSymbols = Object.keys(p.coins).map(s => s.replace('USDT',''));
  $('symbolBadge').innerHTML = `<span class="badge badge-purple">PORTFOLIO</span>`;
  $('statusDot').className = 'status-dot running';
  $('statusLabel').textContent = `${activeCoins.length} coin${activeCoins.length!==1?'s':''} active`;
  $('allocBadge').innerHTML = `${allSymbols.join(' ¬∑ ')}`;
  const totalEquity = p.total_equity || 0;
  const totalPnl = p.total_pnl || 0;
  const pnlPct = p.total_pnl_pct || 0;
  const available = p.available_balance || 0;
  const deployed = Math.max(0, totalEquity - available);
  const deployedPct = totalEquity > 0 ? (deployed / totalEquity * 100) : 0;
  $('cEquity').textContent = fmtUsd(totalEquity);
  $('cEquitySub').innerHTML = `Available: ${fmtUsd(available)}`;
  $('cRealPnl').innerHTML = `<span style="color:${pctColor(totalPnl)}">${fmtUsd(totalPnl)}</span>`;
  $('cRealPnlSub').innerHTML = `<span style="color:${pctColor(pnlPct)}">${pnlPct>=0?'+':''}${fmt(pnlPct)}%</span> total`;
  $('cRealPnl').parentElement.querySelector('.card-label').textContent = 'Portfolio PnL';
  let totalDeals = 0;
  Object.values(p.coins).forEach(c => { if(c.long_deal) totalDeals++; if(c.short_deal) totalDeals++; });
  $('cUnrealPnl').textContent = totalDeals;
  $('cUnrealPnl').parentElement.querySelector('.card-label').textContent = 'Open Deals';
  $('cUnrealPnlSub').textContent = `across ${Object.keys(p.coins).length} coins`;
  $('cWinLoss').innerHTML = `<span style="color:${deployedPct>60?'var(--green)':deployedPct>30?'var(--amber)':'var(--text)'}">${fmt(deployedPct,0)}%</span>`;
  $('cWinLoss').parentElement.querySelector('.card-label').textContent = 'Capital Deployed';
  $('cWinLossSub').textContent = `${fmtUsd(deployed)} of ${fmtUsd(totalEquity)}`;
  const totalCompleted = Object.values(p.coins).reduce((a,c) => a + (c.deals_completed||0), 0);
  $('cWinRate').textContent = totalCompleted;
  $('cWinRate').parentElement.querySelector('.card-label').textContent = 'Deals Completed';
  $('cWinRateSub').textContent = 'across all coins';
  $('cAvgROI').textContent = (p.capital_reserve_pct || 10) + '%';
  $('cAvgROI').parentElement.querySelector('.card-label').textContent = 'Capital Reserve';
  $('cAvgROISub').textContent = `${fmtUsd(available)} available`;
  renderCoinSelector(p);
  $('adaptiveSection').style.display = 'none';
  renderPortfolioDeals(p);
  renderRotationHistory(p);
  renderPortfolioBottom(p);
}

function renderCoinSelector(p) {
  $('coinSelectorSection').style.display = '';
  const coins = p.coins || {};
  $('coinSelectorCount').textContent = `(${Object.keys(coins).length} / ${p.max_coins || 3})`;
  const regimeColors = {ACCUMULATION:'var(--blue)',RANGING:'var(--purple)',MILD_TREND:'var(--green)',TRENDING:'var(--green)',CHOPPY:'var(--amber)',EXTREME:'var(--red)',DISTRIBUTION:'var(--amber)'};
  let html = '';
  Object.entries(coins).forEach(([sym, c]) => {
    const isWinding = c.status === 'winding_down';
    const dirArrow = c.trend_direction === 'bullish' ? '‚ñ≤' : '‚ñº';
    const dirColor = c.trend_direction === 'bullish' ? 'var(--green)' : 'var(--red)';
    const regColor = regimeColors[c.regime] || 'var(--text2)';
    html += `<div class="coin-mini-card${isWinding?' winding-down':''}">
      <div class="coin-header"><span class="coin-symbol">${sym.replace('USDT','')}</span><span class="coin-score">Score: ${fmt(c.scanner_score||0,1)}</span></div>
      <div class="coin-details">
        <span class="badge badge-blue">${fmt(c.alloc_pct||0,0)}% alloc</span>
        <span class="badge" style="background:${regColor}22;color:${regColor}">${c.regime||'--'}</span>
        <span style="color:${dirColor};font-weight:700">${dirArrow}</span>
        ${isWinding?'<span class="badge badge-amber">winding down</span>':'<span class="badge badge-green">active</span>'}
      </div>
      <div style="font-size:.68rem;color:var(--text3);margin-top:6px">${fmtUsd(c.alloc_capital||0)} ¬∑ ${c.deals_completed||0} deals ¬∑ PnL: <span style="color:${pctColor(c.pnl||0)}">${fmtUsd(c.pnl||0)}</span></div>
    </div>`;
  });
  $('coinSelectorGrid').innerHTML = html;
  $('scannerLastRun').textContent = p.scanner_last_run ? new Date(p.scanner_last_run).toLocaleTimeString() : '--';
  $('scannerNextRun').textContent = p.scanner_next_run ? new Date(p.scanner_next_run).toLocaleTimeString() : '--';
}

function renderPortfolioDeals(p) {
  const coins = p.coins || {};
  const coinEntries = Object.entries(coins);
  let html = '';
  coinEntries.forEach(([sym, c], idx) => {
    const dirArrow = c.trend_direction === 'bullish' ? '‚ñ≤' : '‚ñº';
    const dirColor = c.trend_direction === 'bullish' ? 'var(--green)' : 'var(--red)';
    const allocInfo = c.regime_alloc ? `${Math.round(c.regime_alloc.long*100)}%L / ${Math.round(c.regime_alloc.short*100)}%S` : '';
    const isCollapsed = coinEntries.length >= 3 && idx > 0;
    html += `<div class="coin-section">
      <div class="coin-section-header" onclick="this.querySelector('.collapse-icon').classList.toggle('collapsed');this.nextElementSibling.classList.toggle('collapsed')">
        <span class="collapse-icon${isCollapsed?' collapsed':''}">‚ñº</span>
        <h3>${sym.replace('USDT','')} <span class="badge badge-blue" style="font-size:.65rem">${c.regime||'--'}</span> <span style="color:${dirColor};font-size:.8rem">${dirArrow}</span></h3>
        <span style="font-size:.7rem;color:var(--text2);margin-left:auto">${fmt(c.alloc_pct||0,0)}% ¬∑ ${allocInfo}</span>
      </div>
      <div class="coin-section-body${isCollapsed?' collapsed':''}" style="max-height:2000px"><div class="trades-grid">`;
    // Long deal
    html += `<div class="trade-panel"><div class="trade-panel-header"><span class="badge badge-green">LONG</span> ${sym.replace('USDT','')} #${c.long_deal?.deal_id || '--'}</div>`;
    if(c.long_deal && !c.long_deal.closed) {
      const cfg = {tp_pct: c.adaptive_tp?.current_tp_pct||1.5, deviation_pct: c.adaptive_tp?.current_dev_pct||2.5, max_sos:8};
      html += renderSingleTrade(c.long_deal, c.long_deal.avg_entry || c.long_deal.entry_price || 0, cfg);
    } else { html += '<div class="no-deal">No active long deal</div>'; }
    html += '</div>';
    // Short deal
    html += `<div class="trade-panel"><div class="trade-panel-header"><span class="badge badge-red">SHORT</span> ${sym.replace('USDT','')} #${c.short_deal?.deal_id || '--'}</div>`;
    if(c.short_deal && !c.short_deal.closed) {
      const cfg = {tp_pct: c.adaptive_tp?.current_tp_pct||1.5, deviation_pct: c.adaptive_tp?.current_dev_pct||2.5, max_sos:8};
      html += renderSingleTrade(c.short_deal, c.short_deal.avg_entry || c.short_deal.entry_price || 0, cfg);
    } else { html += '<div class="no-deal">No active short deal</div>'; }
    html += '</div></div></div></div>';
  });
  $('dealTitle').textContent = 'Active Trades by Coin';
  $('dealContent').innerHTML = html || '<div class="no-deal">No coins in portfolio</div>';
}

function renderRotationHistory(p) {
  const hist = p.rotation_history || [];
  if(!hist.length) { $('rotationSection').style.display = 'none'; return; }
  $('rotationSection').style.display = '';
  $('rotationBody').innerHTML = hist.slice().reverse().slice(0, 20).map(r => {
    const time = r.time ? new Date(r.time).toLocaleString() : '--';
    const actionClass = r.action === 'added' ? 'rotation-badge-add' : r.action === 'removed' ? 'rotation-badge-remove' : 'rotation-badge-winddown';
    const actionIcon = r.action === 'added' ? '‚ûï' : r.action === 'removed' ? '‚ûñ' : '‚è≥';
    return `<tr><td>${time}</td><td class="${actionClass}">${actionIcon} ${r.action||'--'}</td><td><strong>${(r.symbol||'--').replace('USDT','')}</strong></td><td style="color:var(--text2)">${r.reason||'--'}</td></tr>`;
  }).join('');
}

function renderPortfolioBottom(p) {
  const totalDeals = Object.values(p.coins).reduce((a,c) => a + (c.deals_completed||0), 0);
  const activeCoins = Object.keys(p.coins).filter(s => p.coins[s].status === 'active');
  $('bTrading').innerHTML = activeCoins.map(s => `<span class="badge badge-blue" style="font-size:.65rem;margin:1px">${s.replace('USDT','')}</span>`).join(' ') || '--';
  $('bAvgProfit').textContent = totalDeals + ' deals';
  $('bAvgProfit').previousElementSibling.textContent = 'Total Deals';
  $('bAvgDur').textContent = Object.keys(p.coins).length + ' coins';
  $('bAvgDur').previousElementSibling.textContent = 'Active Coins';
  $('bAvgSO').textContent = (p.max_coins||3) + ' max';
  $('bAvgSO').previousElementSibling.textContent = 'Max Coins';
  $('bUptime').textContent = p.scanner_last_run ? 'Active' : 'Pending';
  $('bUptime').previousElementSibling.textContent = 'Scanner';
}

function renderBottom() {
  if(!status) return;
  const tpTrades = trades.filter(t => t.action === 'TP_HIT');
  const dealOpens = {};
  trades.forEach(t => { if(t.action==='OPEN') dealOpens[t.deal_id] = new Date(t.timestamp); });
  if(tpTrades.length) {
    const avgP = tpTrades.reduce((a,t) => a+parseFloat(t.pnl||0),0)/tpTrades.length;
    $('bAvgProfit').textContent = fmtUsd(avgP);
    const durs = tpTrades.map(t => dealOpens[t.deal_id] ? new Date(t.timestamp)-dealOpens[t.deal_id] : 0).filter(d=>d>0);
    $('bAvgDur').textContent = durs.length ? durStr(durs.reduce((a,b)=>a+b,0)/durs.length) : '--';
    const avgSO = tpTrades.reduce((a,t)=>a+parseInt(t.so_count||0),0)/tpTrades.length;
    $('bAvgSO').textContent = fmt(avgSO,1);
  }
  if(status.start_time) $('bUptime').textContent = durStr(Date.now() - new Date(status.start_time).getTime());
  const dd = status.drawdown_pct || 0;
  const maxDD = status.max_drawdown_threshold || 25;
  $('bDD').textContent = fmt(dd) + '%';
  const ddBar = $('bDDBar');
  ddBar.style.width = Math.min(dd/maxDD*100,100) + '%';
  ddBar.style.background = dd > maxDD*0.7 ? 'var(--red)' : dd > maxDD*0.4 ? 'var(--amber)' : 'var(--green)';
}

// ‚îÄ‚îÄ Spot Scanner Leaderboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchSpotScanner() {
  try {
    const [recRes, t1Res, t2Res] = await Promise.all([
      fetch(DATA_PREFIX+'scanner_recommendation.json?t='+Date.now()),
      fetch(DATA_PREFIX+'scanner_t1.json?t='+Date.now()),
      fetch(DATA_PREFIX+'scanner_t2.json?t='+Date.now())
    ]);
    const safeParse = async (r) => { if(!r.ok) return null; const t = await r.text(); return JSON.parse(t.replace(/\bInfinity\b/g, '9999')); };
    const rec = await safeParse(recRes);
    const t1 = await safeParse(t1Res);
    const t2 = await safeParse(t2Res);
    renderSpotScanner(rec, t1, t2);
  } catch(e) { console.error('fetchSpotScanner error:', e); }
}

function showCmdToast(msg) {
  const t = $('cmdToast');
  t.textContent = msg;
  t.style.display = 'block';
  t.style.opacity = '1';
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.style.display = 'none', 300); }, 2500);
}

function copyCommand(cmdJson, label) {
  const acctDir = ACCOUNT_ID.replace('paper-', '');
  const cmd = `echo '${JSON.stringify(cmdJson)}' > trading/spot/paper/${acctDir}/commands.json`;
  navigator.clipboard.writeText(cmd).then(() => {
    showCmdToast('üìã Copied: ' + label);
  }).catch(() => {
    prompt('Copy this command:', cmd);
  });
}

function renderSpotScanner(rec, t1, t2) {
  const section = $('spotScannerSection');
  if (!section) return;
  if (!rec && !t1 && !t2) { $('spotScannerTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text3)">No scanner data available</td></tr>'; return; }

  if (t1) {
    $('spotScanTotal').textContent = t1.total_pairs_scanned + ' pairs';
    $('spotScanMature').textContent = t1.passed_maturity + ' passed';
    $('spotScanQualified').textContent = (t1.passed_technical || t1.shortlist_size || 0) + ' qualified';
  }
  if (rec && rec.timestamp) {
    const d = new Date(rec.timestamp);
    const ago = Math.round((Date.now() - d.getTime()) / 60000);
    $('spotScanLastRun').textContent = d.toLocaleTimeString() + ' (' + (ago < 60 ? ago+'m ago' : Math.round(ago/60)+'h ago') + ')';
    if (rec.action === 'HOLD') {
      $('spotScanAction').className = 'badge badge-green'; $('spotScanAction').textContent = '‚úì HOLD';
      $('spotScanActionText').textContent = `Current pick remains optimal (score: ${rec.best_score?.toFixed(1) || '--'})`;
    } else {
      $('spotScanAction').className = 'badge badge-amber'; $('spotScanAction').textContent = '‚Üª ROTATE';
      $('spotScanActionText').textContent = `Consider switching to ${(rec.best_coin||'').replace('/USDT','')} (${rec.best_score?.toFixed(1)} vs ${rec.current_score?.toFixed(1)})`;
    }
    $('spotScannerStatus').textContent = rec.action === 'HOLD' ? '‚Äî Holding current' : '‚Äî Rotation suggested';
  }

  if (t2 && t2.rankings && t2.rankings.length) {
    const activeSymbols = status ? (status.symbols || Object.keys(status.coins || {})) : [];
    const lowestActive = activeSymbols.length > 0 ? t2.rankings.filter(r => activeSymbols.includes(r.symbol)).sort((a,b) => a.composite_score - b.composite_score)[0] : null;
    const maxCoins = status ? (status.max_coins || 3) : 3;
    const canAdd = activeSymbols.length < maxCoins;

    $('spotScannerTableBody').innerHTML = t2.rankings.map((r, i) => {
      const isActive = activeSymbols.includes(r.symbol);
      const rowBg = isActive ? 'background:rgba(63,185,80,.08)' : '';
      const statusBadge = isActive
        ? '<span class="badge badge-green">ACTIVE</span>'
        : '<span class="badge badge-gray">Available</span>';

      let actionBtns = '';
      if (isActive) {
        actionBtns = `<button onclick="copyCommand([{action:'remove_coin',symbol:'${r.symbol}'}],'Remove ${r.symbol.replace('/USDT','')}')" style="background:rgba(248,81,73,.15);color:var(--red);border:1px solid rgba(248,81,73,.3);padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer">Remove</button>`;
      } else {
        if (canAdd) {
          actionBtns += `<button onclick="copyCommand([{action:'add_coin',symbol:'${r.symbol}'}],'Add ${r.symbol.replace('/USDT','')}')" style="background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.3);padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer;margin-right:4px">Add</button>`;
        }
        if (lowestActive && r.composite_score > lowestActive.composite_score) {
          actionBtns += `<button onclick="copyCommand([{action:'switch_coin',from:'${lowestActive.symbol}',to:'${r.symbol}'}],'Switch to ${r.symbol.replace('/USDT','')}')" style="background:rgba(210,153,34,.15);color:var(--amber);border:1px solid rgba(210,153,34,.3);padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer">Switch</button>`;
        }
      }

      const ddColor = r.max_drawdown_pct < -5 ? 'var(--red)' : r.max_drawdown_pct < -3 ? 'var(--amber)' : 'var(--green)';
      return `<tr style="${rowBg}"><td style="color:var(--text3);font-weight:600">${i+1}</td><td style="font-weight:600">${r.symbol.replace('/USDT','')}</td><td><span style="font-size:1.1rem;font-weight:700;color:var(--blue)">${r.composite_score.toFixed(1)}</span></td><td style="color:var(--green)">${r.daily_roi_pct.toFixed(3)}%</td><td>${r.win_rate.toFixed(0)}%</td><td style="color:${ddColor}">${r.max_drawdown_pct.toFixed(2)}%</td><td>${statusBadge}</td><td>${actionBtns}</td></tr>`;
    }).join('');
  }
}

async function fetchScanner() {
  try {
    const [recRes, t1Res, t2Res] = await Promise.all([
      fetch(DATA_PREFIX+'scanner_recommendation.json?t='+Date.now()),
      fetch(DATA_PREFIX+'scanner_t1.json?t='+Date.now()),
      fetch(DATA_PREFIX+'scanner_t2.json?t='+Date.now())
    ]);
    const safeParse = async (r) => { if(!r.ok) return null; const t = await r.text(); return JSON.parse(t.replace(/\bInfinity\b/g, '9999')); };
    const rec = await safeParse(recRes);
    const t1 = await safeParse(t1Res);
    const t2 = await safeParse(t2Res);
    renderScanner(rec, t1, t2);
  } catch(e) {}
}

function renderScanner(rec, t1, t2) {
  const section = $('scannerSection');
  if (!rec && !t1 && !t2) { section.style.display = 'none'; return; }
  section.style.display = '';
  if (t1) {
    $('scanFunnelTotal').textContent = t1.total_pairs_scanned + ' pairs';
    $('scanFunnelMature').textContent = t1.passed_maturity + ' passed';
    $('scanFunnelTech').textContent = (t1.passed_technical || t1.shortlist_size || 0) + ' qualified';
    const fc = t1.maturity_filter_counts || {};
    $('scanFilterBreakdown').innerHTML = [
      {label:'Too New (<60d)', val:fc.too_new||0, color:'var(--amber)'},
      {label:'Price Swing (>120%)', val:fc.price_swing||0, color:'var(--red)'},
      {label:'Low Volume (<$1M)', val:fc.low_volume||0, color:'var(--purple)'},
      {label:'Volume Spike (>4√ó)', val:fc.volume_spike||0, color:'var(--blue)'},
      {label:'Insufficient Data', val:fc.insufficient_30d_data||0, color:'var(--text3)'}
    ].map(f => `<div style="text-align:center;padding:8px;background:var(--bg);border-radius:6px;border:1px solid var(--border)"><div style="font-size:1.3rem;font-weight:700;color:${f.color}">${f.val}</div><div style="font-size:.65rem;color:var(--text2);margin-top:2px">${f.label}</div></div>`).join('');
  }
  if (rec) {
    const actionEl = $('scanAction'), textEl = $('scanActionText');
    if (rec.action === 'HOLD') {
      actionEl.className = 'badge badge-green'; actionEl.textContent = '‚úì HOLD';
      textEl.textContent = `${rec.current_coin.replace('/USDT','')} remains the best pick (score: ${rec.best_score.toFixed(1)})`;
    } else {
      actionEl.className = 'badge badge-amber'; actionEl.textContent = '‚Üª ROTATE';
      textEl.textContent = `Switch from ${rec.current_coin.replace('/USDT','')} to ${rec.best_coin.replace('/USDT','')} (${rec.best_score.toFixed(1)} vs ${rec.current_score.toFixed(1)})`;
    }
    if (rec.timestamp) {
      const d = new Date(rec.timestamp);
      const ago = Math.round((Date.now() - d.getTime()) / 60000);
      $('scanLastRun').textContent = d.toLocaleTimeString() + ' (' + (ago < 60 ? ago+'m ago' : Math.round(ago/60)+'h ago') + ')';
    }
    $('scannerStatus').textContent = rec.action === 'HOLD' ? '‚Äî Holding current' : '‚Äî Rotation suggested';
  }
  if (t2 && t2.rankings && t2.rankings.length) {
    $('scannerTableBody').innerHTML = t2.rankings.map((r, i) => {
      const isCurrent = rec && r.symbol === rec.current_coin;
      const rowStyle = isCurrent ? 'background:rgba(88,166,255,.06)' : '';
      const nameExtra = isCurrent ? ' <span style="font-size:.6rem;color:var(--blue)">‚óè ACTIVE</span>' : '';
      const ddColor = r.max_drawdown_pct < -5 ? 'var(--red)' : r.max_drawdown_pct < -3 ? 'var(--amber)' : 'var(--green)';
      return `<tr style="${rowStyle}"><td style="color:var(--text3);font-weight:600">${i+1}</td><td style="font-weight:600">${r.symbol.replace('/USDT','')}${nameExtra}</td><td><span style="font-size:1.1rem;font-weight:700;color:var(--blue)">${r.composite_score.toFixed(1)}</span></td><td style="color:var(--green)">${r.daily_roi_pct.toFixed(3)}%</td><td>${r.deals_per_day.toFixed(1)}</td><td>${r.win_rate.toFixed(0)}%</td><td style="color:${ddColor}">${r.max_drawdown_pct.toFixed(2)}%</td><td style="color:var(--green)">$${r.total_profit.toFixed(2)}</td><td>${r.avg_so_per_deal.toFixed(1)}</td><td>${r.friendly_regime_pct.toFixed(0)}%</td></tr>`;
    }).join('');
  }
}

async function init() {
  await Promise.all([fetchStatus(), fetchHistory(), fetchTrades(), ...(IS_SPOT ? [fetchSpotScanner()] : [fetchScanner()])]);
  if (!IS_SPOT) renderCharts();
}
init();

setInterval(async () => { await fetchStatus(); await fetchTrades(); countdownVal = 15; }, 15000);
setInterval(() => { if (IS_SPOT) fetchSpotScanner(); else fetchScanner(); }, 300000);
setInterval(() => { historyCountdown--; if(historyCountdown <= 0) { fetchHistory().then(renderCharts); historyCountdown = 300; } }, 1000);
setInterval(() => { countdownVal = Math.max(0, countdownVal - 1); $('countdown').textContent = countdownVal; }, 1000);
setInterval(() => { if(status?.start_time) $('bUptime').textContent = durStr(Date.now() - new Date(status.start_time).getTime()); }, 1000);
</script>
</body>
</html>